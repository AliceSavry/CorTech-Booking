<script>
        class EventApp {
            constructor() {
                this.githubConfig = { owner: "", repo: "", path: "index.html", token: "" };
                this.defaultData = {
                    events: [
                        { id: 1, title: "Exemple d'évènement", date: "2025-09-01", location: "En ligne", capacity: 50, image: null, description: "Ceci est un exemple. Connectez-vous en Admin pour le supprimer et créer les vôtres." }
                    ],
                    settings: { orgName: "Mon Asso", themeColor: "#2563eb", logoUrl: null, adminPassword: "admin" }
                };
                this.state = this.loadState();
                this.init();
            }

            loadState() {
                const storedData = localStorage.getItem('asso_app_data');
                const storedGh = localStorage.getItem('asso_gh_config');
                if(storedGh) this.githubConfig = JSON.parse(storedGh);
                return storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(this.defaultData));
            }

            saveState() {
                localStorage.setItem('asso_app_data', JSON.stringify(this.state));
                this.applyTheme();
                this.renderEvents();
            }

            init() {
                document.getElementById('footerYear').textContent = new Date().getFullYear();
                this.applyTheme();
                this.renderEvents();
                // Remplit les champs GitHub avec ce qu'on a en mémoire
                if(this.githubConfig.owner) document.getElementById('ghOwner').value = this.githubConfig.owner;
                if(this.githubConfig.repo) document.getElementById('ghRepo').value = this.githubConfig.repo;
                if(this.githubConfig.token) document.getElementById('ghToken').value = this.githubConfig.token;
            }

            applyTheme() {
                const s = this.state.settings;
                document.documentElement.style.setProperty('--primary-color', s.themeColor);
                document.getElementById('navOrgName').textContent = s.orgName;
                document.getElementById('footerOrgName').textContent = s.orgName;
                document.getElementById('setOrgName').value = s.orgName;
                document.getElementById('setThemeColor').value = s.themeColor;
                const logo = document.getElementById('navLogo');
                if (s.logoUrl) { logo.src = s.logoUrl; logo.classList.remove('hidden'); }
            }

            renderEvents() {
                const grid = document.getElementById('eventsGrid');
                grid.innerHTML = '';
                this.state.events.forEach(evt => {
                    const regs = (this.state.registrations || []).filter(r => r.eventId == evt.id && r.status === 'confirmed');
                    const remaining = evt.capacity - regs.length;
                    const isFull = remaining <= 0;
                    const imgHtml = evt.image ? `<img src="${evt.image}" class="w-full h-48 object-cover">` : `<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-image fa-3x"></i></div>`;
                    const btnHtml = isFull 
                        ? `<button onclick="app.openBookingModal(${evt.id}, true)" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded">Liste d'attente</button>`
                        : `<button onclick="app.openBookingModal(${evt.id}, false)" class="w-full btn-theme font-bold py-2 px-4 rounded">S'inscrire (${remaining} places)</button>`;

                    const card = document.createElement('div');
                    card.className = "bg-white rounded-lg shadow-lg overflow-hidden flex flex-col hover:shadow-xl transition-shadow";
                    card.innerHTML = `${imgHtml}<div class="p-6 flex-grow"><h3 class="font-bold text-xl mb-2">${evt.title}</h3><p class="text-gray-600 text-sm mb-4"><i class="far fa-calendar-alt"></i> ${evt.date} &bull; ${evt.location}</p><p class="text-gray-700 text-base line-clamp-3">${evt.description}</p></div><div class="px-6 pb-6 mt-auto">${btnHtml}</div>`;
                    grid.appendChild(card);
                });
            }

            openBookingModal(id, isWaitlist) {
                const evt = this.state.events.find(e => e.id == id);
                if(!evt) return;
                document.getElementById('bookingEventId').value = id;
                document.getElementById('bookingEventTitle').innerHTML = isWaitlist ? `<span class="text-orange-600">[LISTE D'ATTENTE]</span> ${evt.title}` : `Pour : <strong>${evt.title}</strong>`;
                document.getElementById('bookingForm').reset();
                this.openModal('modalBooking');
            }

            handleBooking(e) {
                e.preventDefault();
                const evtId = document.getElementById('bookingEventId').value;
                const evt = this.state.events.find(ev => ev.id == evtId);
                const currentRegs = (this.state.registrations || []).filter(r => r.eventId == evtId && r.status === 'confirmed').length;
                const status = currentRegs >= evt.capacity ? 'waitlist' : 'confirmed';

                if (!this.state.registrations) this.state.registrations = [];
                const newReg = {
                    id: Date.now(),
                    eventId: evtId, eventName: evt.title,
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    phone: document.getElementById('userPhone').value,
                    status: status, date: new Date().toLocaleDateString()
                };
                this.state.registrations.push(newReg);
                this.saveState();
                
                if(typeof emailjs !== 'undefined') {
                    const params = { event_title: evt.title, user_name: newReg.name, user_email: newReg.email, user_status: status, admin_email: "accueil@cor-tech.fr" };
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params).catch(e => console.error(e));
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {...params, user_email: "accueil@cor-tech.fr"}).catch(e=>{});
                }
                
                this.closeModal('modalBooking');
                alert(status === 'confirmed' ? "Inscription confirmée !" : "Vous êtes sur liste d'attente.");
                this.renderEvents();
            }

            openAdminLogin() { this.openModal('modalLogin'); }
            
            handleLogin(e) {
                e.preventDefault();
                if (document.getElementById('adminPasswordInput').value === this.state.settings.adminPassword) {
                    this.closeModal('modalLogin');
                    this.openModal('modalAdmin');
                    this.renderAdminEvents();
                    this.renderRegistrations();
                    this.switchTab('events');
                } else { alert("Mot de passe incorrect"); }
            }

            renderAdminEvents() {
                document.getElementById('adminEventsList').innerHTML = this.state.events.map(evt => `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded border">
                        <div><strong>${evt.title}</strong> <span class="text-sm text-gray-500">(${evt.date})</span></div>
                        <div>
                            <button onclick="app.editEvent(${evt.id})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="app.deleteEvent(${evt.id})" class="text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            }

            saveEvent(e) {
                e.preventDefault();
                const id = document.getElementById('editEventId').value;
                const file = document.getElementById('eventImage').files[0];
                
                const process = (img) => {
                    const data = {
                        id: id ? parseInt(id) : Date.now(),
                        title: document.getElementById('eventTitle').value,
                        date: document.getElementById('eventDate').value,
                        location: document.getElementById('eventLocation').value,
                        capacity: document.getElementById('eventCapacity').value,
                        description: document.getElementById('eventDesc').value,
                        image: img
                    };
                    if (id) {
                        const idx = this.state.events.findIndex(e => e.id == id);
                        if (!img) data.image = this.state.events[idx].image;
                        this.state.events[idx] = data;
                    } else {
                        if (!img) data.image = null;
                        this.state.events.push(data);
                    }
                    this.saveState();
                    this.renderAdminEvents();
                    this.resetEventForm();
                    alert("Enregistré localement. N'oubliez pas de 'Sauvegarder sur Internet' !");
                };

                if(file) {
                    const reader = new FileReader();
                    reader.onload = e => process(e.target.result);
                    reader.readAsDataURL(file);
                } else process(null);
            }

            deleteEvent(id) {
                if(confirm("Supprimer ?")) {
                    this.state.events = this.state.events.filter(e => e.id != id);
                    this.saveState();
                    this.renderAdminEvents();
                }
            }
            editEvent(id) {
                const e = this.state.events.find(x => x.id == id);
                document.getElementById('editEventId').value = e.id;
                document.getElementById('eventTitle').value = e.title;
                document.getElementById('eventDate').value = e.date;
                document.getElementById('eventLocation').value = e.location;
                document.getElementById('eventCapacity').value = e.capacity;
                document.getElementById('eventDesc').value = e.description;
            }
            resetEventForm() { document.getElementById('editEventId').value = ""; document.querySelector('#view-events form').reset(); }

            renderRegistrations() {
                const regs = this.state.registrations || [];
                document.getElementById('registrationsTableBody').innerHTML = regs.map(r => `
                    <tr><td class="px-5 py-2 border-b bg-white text-sm">${r.eventName}</td>
                    <td class="px-5 py-2 border-b bg-white text-sm font-bold">${r.name}</td>
                    <td class="px-5 py-2 border-b bg-white text-sm">${r.email}</td>
                    <td class="px-5 py-2 border-b bg-white text-sm"><span class="px-2 py-1 rounded-full ${r.status==='confirmed'?'bg-green-200 text-green-900':'bg-orange-200 text-orange-900'}">${r.status}</span></td></tr>
                `).join('');
            }

            saveCustomSettings(e) {
                e.preventDefault();
                this.state.settings.orgName = document.getElementById('setOrgName').value;
                this.state.settings.themeColor = document.getElementById('setThemeColor').value;
                // Note: La config Github est désormais sauvegardée dans pushToGitHub
                
                const file = document.getElementById('setLogo').files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = ev => { this.state.settings.logoUrl = ev.target.result; this.saveState(); alert("Sauvegardé !"); };
                    reader.readAsDataURL(file);
                } else { this.saveState(); alert("Sauvegardé !"); }
            }

            changePassword(e) {
                e.preventDefault();
                const p = document.getElementById('setAdminPass').value;
                if(p) { this.state.settings.adminPassword = p; this.saveState(); alert("Mot de passe changé."); }
            }

            // --- NOUVELLE VERSION CORRIGÉE DE LA SAUVEGARDE GITHUB ---
            async pushToGitHub() {
                // 1. Lire les valeurs directement dans les cases
                const owner = document.getElementById('ghOwner').value.trim();
                const repo = document.getElementById('ghRepo').value.trim();
                const token = document.getElementById('ghToken').value.trim();

                // 2. Sauvegarder dans la mémoire locale
                this.githubConfig = { owner, repo, token, path: "index.html" };
                localStorage.setItem('asso_gh_config', JSON.stringify(this.githubConfig));

                // 3. Vérifications
                if(!owner || !repo || !token) return alert("Configuration GitHub incomplète. Vérifiez les 3 cases.");
                if(owner.includes('@')) return alert("ERREUR: Le 'Pseudo GitHub' ne doit pas être un email.\nMettez votre nom d'utilisateur (ex: AliceFormation).");

                if(!confirm("Mettre à jour le site public ? Cela prendra environ 2 min.")) return;

                const btn = document.getElementById('btnPushGithub');
                const oldHTML = btn.innerHTML;
                btn.innerHTML = '<div class="loader"></div> Envoi...'; btn.disabled = true;

                try {
                    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${this.githubConfig.path}`;
                    
                    // Lecture du fichier actuel
                    const getRes = await fetch(apiUrl, { headers: { "Authorization": `token ${token}` } });
                    if(!getRes.ok) throw new Error("Accès refusé. Vérifiez le Pseudo, le nom du Repo et le Token.");
                    const getData = await getRes.json();
                    
                    // Préparation du nouveau contenu
                    const currentContent = new TextDecoder().decode(Uint8Array.from(atob(getData.content), c => c.charCodeAt(0)));
                    const newDataJson = JSON.stringify(this.state, null, 4);
                    // Remplacement intelligent
                    const newContent = currentContent.replace(/(this\.defaultData\s*=\s*)({[\s\S]*?})(;)/, `$1${newDataJson}$3`);
                    const contentEncoded = btoa(unescape(encodeURIComponent(newContent)));

                    // Envoi de la mise à jour
                    const putRes = await fetch(apiUrl, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: "Update via Admin", content: contentEncoded, sha: getData.sha })
                    });
                    if(!putRes.ok) throw new Error("Erreur d'écriture sur GitHub.");
                    
                    alert("✅ SUCCÈS ! Votre site a été mis à jour.\nLes changements seront visibles dans 2-3 minutes.");
                } catch(err) { 
                    console.error(err);
                    alert("Erreur : " + err.message); 
                } 
                finally { btn.innerHTML = oldHTML; btn.disabled = false; }
            }

            openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            closeModal(id) { document.getElementById(id).classList.add('hidden'); }
            switchTab(t) {
                ['events','registrations','settings'].forEach(x => {
                    document.getElementById(`view-${x}`).classList.add('hidden');
                    document.getElementById(`tab-${x}`).classList.remove('border-theme','text-theme');
                });
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.getElementById(`tab-${t}`).classList.add('border-theme','text-theme');
            }
        }
        const app = new EventApp();
    </script>
