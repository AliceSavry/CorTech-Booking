<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Cor-Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': 'var(--primary-color)',
                    }
                }
            }
        }
    </script>
    <style>
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }
        body { font-family: 'Rajdhani', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans flex flex-col min-h-screen">

    <div id="loading">
        <div class="spinner"></div>
    </div>
    
    <nav class="bg-gray-900 header-shadow sticky top-0 z-40 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-3">
            <img id="logoSite" src="" class="h-10 w-10 object-contain hidden rounded-full border border-gray-700 p-0.5">
            <h1 id="orgName" class="text-3xl font-bold text-white tracking-widest">Cor-Tech</h1>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 flex-grow hidden" id="mainContent">

        <div class="lg:col-span-2 space-y-8">
            <div id="eventsContainer" class="bg-gray-800 rounded-xl shadow-2xl p-6 border-l-4 border-primary">
                <h2 class="text-xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-calendar-alt text-primary mr-3"></i> Évènements à venir</h2>
                <div id="eventsList" class="space-y-4">
                    </div>
                <div id="noEvents" class="hidden text-center text-gray-500 py-8">
                    <i class="fas fa-box-open text-4xl mb-3"></i>
                    <p>Aucun événement n'est programmé pour le moment.</p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-bullhorn text-red-500 mr-3"></i> Dernières Actualités</h2>
                <div id="newsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
                <div id="noNews" class="hidden text-center text-gray-500 py-8">
                    <i class="fas fa-newspaper text-4xl mb-3"></i>
                    <p>Aucune actualité récente à afficher.</p>
                </div>
            </div>
        </div>

        <div class="space-y-8">

            <div class="bg-gray-800 rounded-xl shadow-xl p-6 border border-gray-700">
                <h2 class="text-xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-clock text-orange-400 mr-3"></i> Horaires</h2>
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-gray-300 mb-1">Période Scolaire :</h3>
                        <pre id="hoursSchool" class="text-gray-400 whitespace-pre-wrap text-sm"></pre>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-300 mb-1">Vacances :</h3>
                        <pre id="hoursHolidays" class="text-gray-400 whitespace-pre-wrap text-sm"></pre>
                    </div>
                </div>
            </div>

            <div id="socialContainer" class="bg-gray-800 rounded-xl shadow-xl p-6 border border-gray-700">
                <h2 class="text-xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-share-alt text-teal-400 mr-3"></i> Nous suivre</h2>
                <div id="socialLinks" class="flex flex-wrap gap-4 justify-center">
                    </div>
            </div>

        </div>

    </main>

    <footer class="bg-gray-900 text-gray-400 p-6 mt-12 border-t border-gray-800">
        <div class="max-w-7xl mx-auto text-center">
            <p id="orgFooterName" class="font-bold text-lg text-white mb-1"></p>
            <p>&copy; <span id="currentYear"></span> Cor-Tech. Tous droits réservés.</p>
            
            <p class="mt-2 text-sm text-gray-500">
                <a href="mentions.html" class="text-gray-500 hover:text-primary underline">Mentions Légales</a>
                | <a href="admin.html" class="text-gray-500 hover:text-primary underline">Administration</a>
            </p>
        </div>
    </footer>


    <div id="modalBooking" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden" onclick="closeBookingModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative" onclick="event.stopPropagation()">
            <button onclick="closeBookingModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-xl"><i class="fas fa-times"></i></button>
            <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Inscription</h3>
            <p id="modalBookingEventTitle" class="font-semibold text-lg text-primary mb-2"></p>
            <p id="modalBookingEventDetails" class="text-sm text-gray-600 mb-4"></p>
            
            <form id="bookingForm" class="space-y-4">
                <div>
                    <label for="nom" class="block text-sm font-medium text-gray-700">Nom / Prénom</label>
                    <input type="text" id="nom" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700">Téléphone (Optionnel)</label>
                    <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary">
                </div>
                <input type="hidden" id="eventTitle">
                <input type="hidden" id="eventId">

                <button type="submit" id="submitBookingBtn" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-black bg-primary hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    S'inscrire <i class="fas fa-paper-plane ml-2"></i>
                </button>
                <p id="formMessage" class="mt-3 text-sm text-center"></p>
                <p class="text-xs text-gray-500 mt-2 text-center">Vos données seront utilisées uniquement pour la gestion de l'événement. <a href="mentions.html" target="_blank" class="text-primary hover:underline">Mentions Légales.</a></p>
            </form>
        </div>
    </div>

    <div id="modalNewsDetail" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden" onclick="closeNewsDetailModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full h-[90vh] flex flex-col relative" onclick="event.stopPropagation()">
            <button onclick="closeNewsDetailModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-xl z-10"><i class="fas fa-times"></i></button>
            
            <div id="newsDetailContent" class="overflow-y-auto p-6 flex-grow">
                </div>

            <div class="p-4 border-t border-gray-200 text-center">
                <button onclick="closeNewsDetailModal()" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-black bg-primary hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">Fermer</button>
            </div>
        </div>
    </div>


    <script>
        const CHARTE_PRIMARY_COLOR = '#00FFFF'; 

        let DATA = {};
        let SHA = '';
        let EVENTS = [];
        let NEWS = [];
        let SETTINGS = {};

        // 1. Initialisation
        async function initApp() {
            try {
                // Utilisation de Date.now() pour forcer le rechargement sans cache
                const response = await fetch('data.json?t=' + Date.now()); 
                if (!response.ok) throw new Error('Erreur de chargement de data.json');
                DATA = await response.json();
                
                // Extraction des données
                EVENTS = DATA.events || [];
                NEWS = DATA.news || [];
                SETTINGS = DATA.settings || {};

                renderApp();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error('Erreur critique au chargement des données:', error);
                document.getElementById('loading').innerHTML = '<p class="text-red-500">Erreur de chargement du portail. (Vérifiez data.json ou votre console F12)</p>';
            }
        }

        // 2. Rendu de l'application
        function renderApp() {
            const S = SETTINGS;

            if (document.getElementById('currentYear')) document.getElementById('currentYear').textContent = new Date().getFullYear();

            const finalColor = (S.themeColor && S.themeColor !== '#000000') ? S.themeColor : CHARTE_PRIMARY_COLOR;
            setThemColor(finalColor);

            const logoEl = document.getElementById('logoSite');
            if (S.logoUrl && logoEl) {
                logoEl.src = S.logoUrl;
                logoEl.classList.remove('hidden');
            }
            if (document.getElementById('orgName')) document.getElementById('orgName').textContent = S.orgName || 'Portail Cor-Tech';
            if (document.getElementById('orgFooterName')) document.getElementById('orgFooterName').textContent = S.orgName || 'Portail Cor-Tech';

            if (document.getElementById('hoursSchool')) document.getElementById('hoursSchool').textContent = S.hours?.school || 'Non défini';
            if (document.getElementById('hoursHolidays')) document.getElementById('hoursHolidays').textContent = S.hours?.holidays || 'Non défini';

            renderSocialLinks(S.social);

            // ANCIENNE LIGNE POTENTIELLEMENT PROBLÉMATIQUE : if(S.emailjs?.publicKey) emailjs.init(S.emailjs.publicKey);
            // Laisser cette ligne commentée ou retirée pour l'instant pour éviter les erreurs d'initialisation externe.
            // Si le site fonctionne, l'erreur était là.

            renderEvents();
            renderNews();
        }

        // 3. Application de la couleur
        function setThemColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
        }

        // 4. Rendu des liens sociaux
        function renderSocialLinks(social) {
            const list = document.getElementById('socialLinks');
            if (!list) return;

            list.innerHTML = '';
            
            const socialIcons = {
                facebook: { icon: 'fab fa-facebook-f', color: 'text-blue-600', name: 'Facebook' },
                instagram: { icon: 'fab fa-instagram', color: 'text-pink-500', name: 'Instagram' },
                tiktok: { icon: 'fab fa-tiktok', color: 'text-white', name: 'TikTok' },
                youtube: { icon: 'fab fa-youtube', color: 'text-red-600', name: 'YouTube' }
            };

            for (const [key, url] of Object.entries(social || {})) {
                if (url && socialIcons[key]) {
                    const iconData = socialIcons[key];
                    list.innerHTML += `
                        <a href="${url}" target="_blank" class="flex items-center justify-center w-12 h-12 rounded-full ${iconData.color} bg-gray-900 border border-gray-700 text-xl hover:shadow-primary hover:border-primary transition duration-300" title="${iconData.name}">
                            <i class="${iconData.icon}"></i>
                        </a>
                    `;
                }
            }
            const socialContainer = document.getElementById('socialContainer');
            if(list.innerHTML === '' && socialContainer) socialContainer.classList.add('hidden');
        }

        // 5. Rendu des événements
        function renderEvents() {
            const list = document.getElementById('eventsList');
            if (!list) return;
            list.innerHTML = '';

            const now = new Date();
            const sortedEvents = EVENTS
                .filter(evt => evt.status !== 'Annulé' && new Date(evt.date) >= now)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const noEventsEl = document.getElementById('noEvents');
            if (sortedEvents.length === 0) {
                if(noEventsEl) noEventsEl.classList.remove('hidden');
                return;
            }

            if(noEventsEl) noEventsEl.classList.add('hidden');

            sortedEvents.forEach(evt => {
                const eventDate = new Date(evt.date);
                const dateStatus = isNaN(eventDate) 
                    ? `<span class="text-red-500 font-semibold">Date Invalide</span>` 
                    : `<i class="fas fa-calendar-day mr-1"></i> ${eventDate.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })}`;

                let statusBadge = '';
                if (evt.status === 'Complet') {
                    statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-orange-600 text-white">Complet</span>`;
                } else if (evt.status === 'Ouvert') {
                    statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-600 text-white">Ouvert</span>`;
                }

                const buttonText = evt.status === 'Complet' ? "Liste d'attente" : "S'inscrire";

                const html = `
                    <div class="flex bg-gray-900 p-3 rounded-xl border border-gray-700 hover:shadow-primary hover:border-primary transition">
                        <div class="flex-shrink-0 w-16 h-16 mr-3 rounded-md overflow-hidden border border-gray-600">
                            ${evt.image ? `<img src="${evt.image}" alt="${evt.title}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-gray-400 text-xs text-center p-1"><i class="fas fa-image"></i></div>`}
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-white">${evt.title}</h3>
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-primary font-semibold">${dateStatus}</p>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-400 overflow-hidden max-h-10">${evt.description}</p>
                            <a href="#" onclick="openBookingModal(${evt.id})" class="text-xs font-semibold text-primary hover:text-white">${buttonText} <i class="fas fa-arrow-right ml-1"></i></a>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        // 6. Rendu des actualités
        function renderNews() {
            const list = document.getElementById('newsList');
            if (!list) return;
            list.innerHTML = '';
            
            const sortedNews = NEWS
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 4);

            const noNewsEl = document.getElementById('noNews');

            if (sortedNews.length === 0) {
                if(noNewsEl) noNewsEl.classList.remove('hidden');
                return;
            }

            if(noNewsEl) noNewsEl.classList.add('hidden');

            sortedNews.forEach(n => {
                const date = new Date(n.date).toLocaleDateString('fr-FR');
                const excerpt = n.content.length > 250 ? n.content.substring(0, 250).replace(/\s\S*$/, '') + '...' : n.content;

                const html = `
                    <div class="bg-gray-800 rounded-xl shadow-xl overflow-hidden flex flex-col h-full hover:shadow-2xl hover:shadow-primary transition duration-300 border border-gray-700">
                        ${n.image ? `<img src="${n.image}" alt="${n.title}" class="w-full h-48 object-cover">` : `<div class="w-full h-48 flex items-center justify-center bg-gray-900 text-gray-500 text-lg"><i class="fas fa-info-circle"></i></div>`}
                        <div class="p-5 flex flex-col flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${n.tag === 'urgent' ? 'bg-red-700 text-white' : 'bg-primary text-black'} self-start mb-2">${n.tag}</span>
                            <h3 class="text-xl font-bold text-white mb-2">${n.title}</h3>
                            <p class="text-sm text-gray-400 mb-3 flex-grow news-content">${excerpt}</p>
                            <div class="flex justify-between items-center pt-3 border-t border-gray-700">
                                <span class="text-xs text-gray-500"><i class="fas fa-clock mr-1"></i> ${date}</span>
                                <a href="#" onclick="openNewsDetail(${n.id})" class="text-sm font-semibold text-primary hover:text-white">Lire la suite</a>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }
        
        // 7. Ouverture de la Modale d'Inscription
        function openBookingModal(eventId) {
            const evt = EVENTS.find(e => e.id === eventId);
            if (!evt) return;

            document.getElementById('modalBookingEventTitle').textContent = evt.title;
            document.getElementById('modalBookingEventDetails').innerHTML = `
                <i class="fas fa-calendar-day mr-1"></i> ${new Date(evt.date).toLocaleDateString('fr-FR')} à ${evt.time}
                <span class="ml-3"><i class="fas fa-map-marker-alt mr-1"></i> ${evt.location}</span>
            `;
            document.getElementById('eventTitle').value = evt.title;
            document.getElementById('eventId').value = evt.id;
            document.getElementById('modalBooking').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            document.getElementById('formMessage').textContent = '';
            document.getElementById('bookingForm').reset();

            setTimeout(() => document.getElementById('nom').focus(), 100);
        }

        // 8. Fermeture de la Modale d'Inscription
        function closeBookingModal(event) {
            if (event && event.target.id !== 'modalBooking') return;
            const modal = document.getElementById('modalBooking');
            if(modal) modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // 9. Envoi du Formulaire d'Inscription (NE FONCTIONNERA PAS SANS INITIALISATION EMAILJS)
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            alert("L'initialisation d'EmailJS est désactivée pour éviter les plantages. Veuillez la réactiver ou utiliser un autre système de formulaire.");
            
            // Pour débloquer l'interface:
            document.getElementById('submitBookingBtn').innerHTML = "S'inscrire <i class=\"fas fa-paper-plane ml-2\"></i>";
            document.getElementById('submitBookingBtn').disabled = false;
        });

        // 10. Ouverture de la Modale d'Actualité
        function openNewsDetail(newsId) {
            const newsItem = NEWS.find(n => n.id === newsId);
            if (!newsItem) return;

            const detailContainer = document.getElementById('newsDetailContent');
            if (!detailContainer) return;

            detailContainer.innerHTML = '';

            const tagClasses = { 'info': 'bg-blue-100 text-blue-800', 'urgent': 'bg-red-100 text-red-800', 'event': 'bg-green-100 text-green-800' };
            const tagText = { 'info': 'Information', 'urgent': 'URGENT', 'event': 'Vie Asso' };
            const tagClass = tagClasses[newsItem.tag] || 'bg-gray-100 text-gray-800';
            const date = new Date(newsItem.date).toLocaleDateString('fr-FR');
            
            const imageHtml = newsItem.image 
                ? `<img src="${newsItem.image}" alt="${newsItem.title}" class="w-full h-auto max-h-[60vh] object-contain mb-4 rounded-lg shadow-md">` 
                : '';

            detailContainer.innerHTML = `
                <div class="pt-6">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tagClass} self-start mb-2">${tagText[newsItem.tag]}</span>
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4">${newsItem.title}</h2>
                    <p class="text-sm text-gray-500 mb-6"><i class="fas fa-calendar-alt mr-1"></i> Publié le ${date}</p>
                    
                    ${imageHtml}

                    <p class="text-lg text-gray-700 whitespace-pre-line">${newsItem.content}</p>
                </div>
            `;

            document.getElementById('modalNewsDetail').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            detailContainer.scrollTop = 0;
        }

        // 11. Fermeture de la Modale d'Actualité
        function closeNewsDetailModal(event) {
            if (event && event.target.id !== 'modalNewsDetail') return;
            const modal = document.getElementById('modalNewsDetail');
            if(modal) modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // Démarrer l'application
        window.onload = initApp;
    </script>
</body>
</html>
