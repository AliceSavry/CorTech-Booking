<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Cor-Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary-color: #2563eb; }
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        /* Loader */
        #loading { position: fixed; inset: 0; background: white; z-index: 50; display: flex; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Fix pour le texte des news (respecte les retours à la ligne) */
        .news-content { white-space: pre-line; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans flex flex-col min-h-screen">

    <div id="loading"><div class="spinner"></div></div>

    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-3">
            <img id="logoSite" src="" class="h-10 w-10 object-contain hidden rounded-full">
            <h1 id="orgName" class="text-2xl font-bold text-gray-900">Cor-Tech</h1>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 hidden" id="mainContent">
        
        <div class="lg:col-span-1 space-y-6">

            <div id="eventsContainer" class="bg-white rounded-lg shadow-lg p-6 border-t-4 border-primary">
                <h2 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center"><i class="fas fa-calendar-alt text-primary mr-3"></i> Évènements à venir</h2>
                <div id="eventsList" class="space-y-4">
                    <p id="noEvents" class="text-gray-500 italic hidden">Aucun événement planifié pour le moment.</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center"><i class="fas fa-clock text-orange-500 mr-3"></i> Horaires</h2>
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-gray-700 mb-1">Période Scolaire :</h3>
                        <pre id="hoursSchool" class="text-gray-600 whitespace-pre-wrap"></pre>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-1">Vacances :</h3>
                        <pre id="hoursHolidays" class="text-gray-600 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </div>

            <div id="socialContainer" class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center"><i class="fas fa-share-alt text-teal-500 mr-3"></i> Nous suivre</h2>
                <div id="socialLinks" class="flex justify-around items-center text-3xl"></div>
            </div>

        </div>


        <div class="lg:col-span-2">
            <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center"><i class="fas fa-bullhorn text-red-500 mr-3"></i> Dernières Actualités</h2>
            <div id="newsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="loadingNews" class="md:col-span-2 text-center text-gray-500">Chargement...</div>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-white p-6 mt-12">
        <div class="max-w-7xl mx-auto text-center">
            <p>&copy; <span id="currentYear"></span> <span id="footerOrgName">Cor-Tech</span>. Tous droits réservés.</p>
        </div>
    </footer>

    <div id="modalBooking" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative">
            <button onclick="document.getElementById('modalBooking').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-primary">Inscription</h2>
            <p id="bookingEventTitle" class="text-gray-600 mb-6 font-medium"></p>
            <form id="bookingForm" onsubmit="handleBooking(event)">
                <input type="hidden" id="bookingEventId">
                <input type="text" id="userName" placeholder="Nom Complet" required class="w-full px-3 py-2 border rounded mb-3">
                <input type="email" id="userEmail" placeholder="Email" required class="w-full px-3 py-2 border rounded mb-3">
                <input type="tel" id="userPhone" placeholder="Téléphone" class="w-full px-3 py-2 border rounded mb-3">
                <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded">Confirmer</button>
            </form>
        </div>
    </div>

    <script>
        let DATA = {};
        const THEME_COLOR = '#2563eb';

        async function initApp() {
            try {
                const response = await fetch('data.json?t=' + Date.now());
                if (!response.ok) throw new Error('Erreur chargement data.json');
                DATA = await response.json();
                
                renderApp();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error("Erreur critique:", error);
                document.getElementById('loading').innerHTML = `<div class="text-center text-red-600 font-bold p-4">Impossible de charger les données du site. ${error.message}</div>`;
            }
        }

        function setThemColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
        }

        function renderApp() {
            const S = DATA.settings;
            if (S.themeColor) setThemColor(S.themeColor); else setThemColor(THEME_COLOR);

            document.getElementById('orgName').textContent = S.orgName || 'Cor-Tech';
            document.getElementById('footerOrgName').textContent = S.orgName || 'Cor-Tech';
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            if(S.logoUrl) { const logo=document.getElementById('logoSite'); logo.src=S.logoUrl; logo.classList.remove('hidden'); }

            document.getElementById('hoursSchool').textContent = S.hours?.school || 'Non défini';
            document.getElementById('hoursHolidays').textContent = S.hours?.holidays || 'Non défini';
            
            renderSocialLinks(S.social);
            renderEvents(DATA.events);
            renderNews(DATA.news);
        }
        
        function renderSocialLinks(social) {
            const linksContainer = document.getElementById('socialLinks');
            linksContainer.innerHTML = '';
            const socialIcons = [
                { key: 'facebook', icon: 'fab fa-facebook-square', color: 'text-blue-600' },
                { key: 'instagram', icon: 'fab fa-instagram', color: 'text-pink-600' },
                { key: 'tiktok', icon: 'fab fa-tiktok', color: 'text-black' },
                { key: 'youtube', icon: 'fab fa-youtube', color: 'text-red-600' }
            ];

            socialIcons.forEach(item => {
                const url = social?.[item.key];
                if (url) {
                    linksContainer.innerHTML += `<a href="${url}" target="_blank" class="${item.color} hover:opacity-75 transition"><i class="${item.icon}"></i></a>`;
                }
            });
            
            if (linksContainer.innerHTML === '') {
                document.getElementById('socialContainer').classList.add('hidden');
            } else {
                 document.getElementById('socialContainer').classList.remove('hidden');
            }
        }

        // RENDU ÉVÈNEMENTS (Colonne 1)
        function renderEvents(events) {
            const list = document.getElementById('eventsList');
            list.innerHTML = '';
            const sortedEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (sortedEvents.length === 0) {
                document.getElementById('noEvents').classList.remove('hidden');
                return;
            }

            sortedEvents.forEach(evt => {
                const eventDate = new Date(evt.date);
                const dateStatus = isNaN(eventDate) 
                    ? `<span class="text-red-500 font-semibold">Date Invalide</span>` 
                    : `<i class="fas fa-calendar-day mr-1"></i> ${eventDate.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })}`;

                const html = `
                    <div class="flex bg-gray-50 p-3 rounded-lg border border-gray-200 hover:shadow-lg transition">
                        <div class="flex-shrink-0 w-16 h-16 mr-3 rounded-md overflow-hidden border border-gray-300">
                            ${evt.image ? `<img src="${evt.image}" alt="${evt.title}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-gray-200 text-gray-500 text-xs text-center p-1"><i class="fas fa-image"></i></div>`}
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-gray-800">${evt.title}</h3>
                            <p class="text-sm text-primary font-semibold">${dateStatus}</p>
                            <p class="text-sm text-gray-500 overflow-hidden max-h-10">${evt.description}</p>
                            <a href="#" onclick="openBookingModal(${evt.id})" class="text-xs font-semibold text-primary hover:text-blue-700">S'inscrire <i class="fas fa-arrow-right ml-1"></i></a>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }
        
        // RENDU NEWS (Colonne 2)
        function renderNews(news) {
            const list = document.getElementById('newsList');
            list.innerHTML = '';
            const sortedNews = news.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedNews.length === 0) {
                list.innerHTML = '<p class="text-gray-500 md:col-span-2 italic">Aucune actualité récente à afficher.</p>';
                return;
            }

            sortedNews.forEach(n => {
                const tagClasses = { 'info': 'bg-blue-100 text-blue-800', 'urgent': 'bg-red-100 text-red-800', 'event': 'bg-green-100 text-green-800' };
                const tagText = { 'info': 'Information', 'urgent': 'URGENT', 'event': 'Vie Asso' };
                const tagClass = tagClasses[n.tag] || 'bg-gray-100 text-gray-800';
                const date = new Date(n.date).toLocaleDateString('fr-FR');

                list.innerHTML += `
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden flex flex-col h-full hover:shadow-xl transition duration-300">
                        ${n.image ? `<img src="${n.image}" alt="${n.title}" class="w-full h-48 object-cover">` : `<div class="w-full h-48 flex items-center justify-center bg-gray-200 text-gray-500 text-lg"><i class="fas fa-info-circle"></i></div>`}
                        <div class="p-5 flex flex-col flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tagClass} self-start mb-2">${tagText[n.tag]}</span>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${n.title}</h3>
                            <p class="text-sm text-gray-600 mb-3 flex-grow news-content">${n.content}</p>
                            <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                                <span class="text-xs text-gray-500"><i class="fas fa-clock mr-1"></i> ${date}</span>
                                <a href="#" onclick="alert('Détails : ${n.title}')" class="text-sm font-semibold text-primary hover:text-blue-700">Lire la suite</a>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // LOGIQUE MODAL ET EMAIL
        function openBookingModal(id) {
            const event = DATA.events.find(e => e.id == id);
            if (!event) return;
            document.getElementById('bookingEventId').value = id;
            document.getElementById('bookingEventTitle').innerHTML = `Pour : <strong>${event.title}</strong>`;
            document.getElementById('modalBooking').classList.remove('hidden');
        }

        function handleBooking(e) {
            e.preventDefault();
            const id = document.getElementById('bookingEventId').value;
            const event = DATA.events.find(x => x.id == id);
            const name = document.getElementById('userName').value;
            const mail = document.getElementById('userEmail').value;
            
            const S = DATA.settings;
            
            if(S.emailjs?.serviceId && S.emailjs?.templateId) {
                const p = { 
                    event_title: event.title, 
                    user_name: name, 
                    user_email: mail, 
                    admin_email: "accueil@cor-tech.fr",
                    user_status: 'Confirmée'
                };
                
                emailjs.send(S.emailjs.serviceId, S.emailjs.templateId, p)
                    .then(() => {
                        alert("Inscription envoyée ! Un email de confirmation a été envoyé.");
                        document.getElementById('modalBooking').classList.add('hidden');
                    })
                    .catch(err => alert("Erreur d'envoi EmailJS. Détails: " + err.text));
            } else {
                alert("Erreur: Les clés EmailJS n'ont pas été configurées dans la page Admin. Contactez l'administrateur.");
                document.getElementById('modalBooking').classList.add('hidden');
            }
        }

        // Lancement au chargement de la page
        initApp();
    </script>
</body>
</html>
