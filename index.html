<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cor-Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <style>
        /* Variables et styles pour le th√®me */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--theme-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .bg-custom-color { background-color: var(--theme-color); }
        .text-custom-color { color: var(--theme-color); }
        .border-custom-color { border-color: var(--theme-color); }
        .hover\:bg-custom-color:hover { background-color: var(--theme-color); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <header class="bg-gray-800 text-white p-4 shadow-md">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img id="logoHeader" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='90' font-size='90' fill='white'>ü§ñ</text></svg>" alt="Logo" class="h-8 w-8 object-contain bg-white rounded-full p-1" style="filter: invert(1);">
                    <h1 id="orgNameHeader" class="text-xl font-bold">Cor-Tech</h1>
                </div>
                <nav>
                    <a href="admin.html" class="text-gray-300 hover:text-white transition duration-300">Admin <i class="fas fa-cog"></i></a>
                </nav>
            </div>
        </header>

        <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

            <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg border-t-4 border-custom-color" id="eventsSection">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-calendar-alt text-custom-color mr-3"></i> √âv√®nements √† venir</h2>
                <div id="eventsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="loader"></div>
                </div>
            </section>
            
            <div class="lg:col-span-1 space-y-6">
                
                <section class="bg-white p-6 rounded-lg shadow-lg" id="newsSection">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-newspaper text-red-500 mr-2"></i> Derni√®res Actualit√©s</h2>
                    <div id="newsContainer" class="space-y-4">
                        <div class="loader"></div>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-orange-500" id="hoursSection">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center text-orange-600"><i class="fas fa-clock mr-2"></i> Horaires</h2>
                    <div id="hoursContainer" class="space-y-3 text-sm text-gray-700">
                        <div>
                            <p class="font-semibold">P√©riode Scolaire :</p>
                            <pre id="hoursSchool" class="whitespace-pre-wrap mt-1"></pre>
                        </div>
                        <div>
                            <p class="font-semibold">Vacances :</p>
                            <pre id="hoursHolidays" class="whitespace-pre-wrap mt-1"></pre>
                        </div>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center text-blue-600"><i class="fas fa-envelope mr-2"></i> Contactez-nous</h2>
                    <form id="contactForm" class="space-y-4">
                        <input type="text" id="contactName" name="name" placeholder="Votre Nom" required class="w-full p-3 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        <input type="email" id="contactEmail" name="email" placeholder="Votre Email" required class="w-full p-3 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500">
                        <textarea id="contactMessage" name="message" placeholder="Votre Message" required rows="4" class="w-full p-3 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition duration-300">Envoyer le Message</button>
                        <p id="formStatus" class="text-sm text-center"></p>
                    </form>
                </section>

                <section class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-share-alt text-gray-500 mr-2"></i> Suivez-nous</h2>
                    <div id="socialContainer" class="flex justify-center space-x-4 text-3xl">
                        </div>
                </section>
            </div>
        </main>

        <footer class="bg-gray-800 text-gray-400 p-4 mt-10">
            <div class="max-w-7xl mx-auto text-center text-sm">
                &copy; <span id="currentYear"></span> <span id="orgNameFooter">Cor-Tech</span>. Tous droits r√©serv√©s.
            </div>
        </footer>
    </div>

    <div id="loadingPanel" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div id="initialLoader" class="loader w-10 h-10 border-4"></div>
        <p id="loadingMessage" class="mt-4 text-xl text-white">Chargement des donn√©es...</p>
        <p id="errorMessage" class="hidden mt-4 text-xl text-red-400 font-bold"></p>
    </div>

    <script>
        let DATA = {};
        let THEME_COLOR = '#2563eb';
        
        // =========================================================================
        // ‚ö†Ô∏è √âTAPE CRITIQUE : REMPLACER CES PLACEHOLDERS PAR VOS IDs GOOGLE FORM
        // VEUILLEZ CHANGER 'VOTRE_ID_NOM_ICI' PAR LE NUM√âRO entry.XXXXXX CORRESPONDANT √Ä CHAQUE CHAMP.
        // =========================================================================
        const ENTRY_ID_NOM = "VOTRE_ID_NOM_ICI";        // Champ "Nom"
        const ENTRY_ID_EMAIL = "VOTRE_ID_EMAIL_ICI";    // Champ "Adresse mail"
        const ENTRY_ID_PHONE = "VOTRE_ID_PHONE_ICI";    // Champ "T√©l√©phone"
        const ENTRY_ID_EVENT = "VOTRE_ID_EVENT_ICI";    // Champ "√âv√®nement"
        // =========================================================================

        /**
         * Initialise l'application : charge les donn√©es et rend l'interface.
         */
        async function initApp() {
            try {
                // 1. Fetch data.json
                const response = await fetch('data.json?t=' + Date.now());
                if (!response.ok) {
                    throw new Error('Fichier data.json non trouv√© ou erreur r√©seau.');
                }
                DATA = await response.json();
                
                // 2. Set Theme Color
                THEME_COLOR = DATA.settings.themeColor || '#2563eb';
                document.documentElement.style.setProperty('--theme-color', THEME_COLOR);

                // 3. Render UI
                renderApp();

            } catch (error) {
                console.error('Erreur au chargement de l\'application:', error);
                document.getElementById('loadingPanel').classList.remove('hidden');
                document.getElementById('initialLoader').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorMessage').innerText = "Impossible de charger les donn√©es du site. " + (error.message || '');
            } finally {
                // Hide loading panel if no critical error occurred
                if (DATA.settings) {
                    document.getElementById('loadingPanel').classList.add('hidden');
                }
            }
        }

        /**
         * Met √† jour l'interface avec les donn√©es charg√©es.
         */
        function renderApp() {
            const S = DATA.settings;
            
            // Header/Footer updates
            document.getElementById('orgNameHeader').innerText = S.orgName || "Cor-Tech";
            document.getElementById('orgNameFooter').innerText = S.orgName || "Cor-Tech";
            document.getElementById('currentYear').innerText = new Date().getFullYear();
            
            // Logo update
            if (S.logoUrl) {
                const logo = document.getElementById('logoHeader');
                logo.src = S.logoUrl;
                logo.style.filter = 'none'; // D√©sactiver l'effet si une image personnalis√©e est pr√©sente
            }

            // Render Sections
            renderEvents();
            renderNews();
            renderHours();
            renderSocial();
            setupContactForm();
        }

        /**
         * Rend la liste des √©v√©nements.
         */
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const sortedEvents = DATA.events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (sortedEvents.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic md:col-span-2">Aucun √©v√©nement n\'est programm√© pour le moment. Revenez bient√¥t !</p>';
                return;
            }

            container.innerHTML = sortedEvents.map(e => {
                const date = e.date ? new Date(e.date).toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }) : 'Date Invalide';
                const statusColor = e.status === 'Ouvert' ? 'bg-green-500' : (e.status === 'Complet' ? 'bg-yellow-500' : 'bg-red-500');

                return `
                    <div class="bg-white border rounded-lg shadow-md overflow-hidden transform hover:scale-[1.02] transition duration-300">
                        <div class="relative h-40 w-full overflow-hidden">
                            <img src="${e.image || 'images/default_event.jpg'}" alt="${e.title}" class="w-full h-full object-cover">
                            <span class="absolute top-2 right-2 ${statusColor} text-white text-xs font-semibold px-3 py-1 rounded-full">${e.status}</span>
                        </div>
                        <div class="p-4">
                            <h3 class="text-xl font-bold text-gray-900">${e.title}</h3>
                            <p class="text-sm text-custom-color font-semibold mb-2"><i class="fas fa-calendar-day mr-1"></i> ${date} - <i class="fas fa-map-marker-alt ml-2 mr-1"></i> ${e.location || 'Lieu Cor-Tech'}</p>
                            <p class="text-gray-600 mb-4">${e.description}</p>
                            <a href="#" onclick="redirectToForm(event, ${e.id})" class="text-custom-color hover:text-blue-700 font-semibold flex items-center">
                                S'inscrire &rarr;
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        /**
         * Rend la liste des actualit√©s.
         */
        function renderNews() {
            const container = document.getElementById('newsContainer');
            const sortedNews = DATA.news.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (sortedNews.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">Aucune actualit√© r√©cente. Revenez plus tard !</p>';
                return;
            }

            container.innerHTML = sortedNews.map(n => {
                const date = new Date(n.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                const tagColor = n.tag === 'urgent' ? 'text-red-500' : (n.tag === 'event' ? 'text-purple-500' : 'text-blue-500');

                return `
                    <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-custom-color shadow-sm">
                        ${n.image ? `<img src="${n.image}" alt="Image d'actualit√©" class="w-full h-32 object-cover rounded mb-3">` : ''}
                        <p class="text-xs font-semibold uppercase ${tagColor} mb-1"><i class="fas fa-tag mr-1"></i> ${n.tag}</p>
                        <h3 class="font-bold text-lg text-gray-900">${n.title}</h3>
                        <p class="text-gray-700 text-sm mt-1">${n.content}</p>
                        <p class="text-xs text-gray-500 mt-2"><i class="fas fa-calendar mr-1"></i> Publi√© le ${date}</p>
                    </div>
                `;
            }).join('');
        }

        /**
         * Rend les horaires d'ouverture.
         */
        function renderHours() {
            document.getElementById('hoursSchool').innerText = DATA.settings.hours?.school || 'Non d√©fini';
            document.getElementById('hoursHolidays').innerText = DATA.settings.hours?.holidays || 'Non d√©fini';
        }

        /**
         * Rend les liens sociaux.
         */
        function renderSocial() {
            const container = document.getElementById('socialContainer');
            const S = DATA.settings.social || {};
            let html = '';

            if (S.facebook) html += `<a href="${S.facebook}" target="_blank" class="text-blue-600 hover:text-blue-800 transition"><i class="fab fa-facebook-square"></i></a>`;
            if (S.instagram) html += `<a href="${S.instagram}" target="_blank" class="text-pink-600 hover:text-pink-800 transition"><i class="fab fa-instagram"></i></a>`;
            if (S.tiktok) html += `<a href="${S.tiktok}" target="_blank" class="text-black hover:text-gray-700 transition"><i class="fab fa-tiktok"></i></a>`;
            if (S.youtube) html += `<a href="${S.youtube}" target="_blank" class="text-red-600 hover:text-red-800 transition"><i class="fab fa-youtube"></i></a>`;
            
            container.innerHTML = html || '<p class="text-sm text-gray-500 italic">Aucun lien social configur√©.</p>';
        }

        /**
         * Configuration et gestion du formulaire de contact (EmailJS).
         */
        function setupContactForm() {
            const S = DATA.settings.emailjs;
            if (S?.publicKey && S?.serviceId && S?.templateId) {
                emailjs.init(S.publicKey);
            } else {
                document.getElementById('contactForm').innerHTML = '<p class="text-red-500">Le service de contact (EmailJS) n\'est pas configur√©. Veuillez contacter l\'administrateur.</p>';
                return;
            }

            document.getElementById('contactForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const btn = this.querySelector('button');
                const status = document.getElementById('formStatus');
                const originalText = btn.innerText;

                btn.disabled = true;
                btn.innerText = 'Envoi en cours...';
                status.className = 'text-sm text-center text-gray-500';
                status.innerText = '';

                const templateParams = {
                    from_name: document.getElementById('contactName').value,
                    from_email: document.getElementById('contactEmail').value,
                    message: document.getElementById('contactMessage').value,
                };

                emailjs.send(S.serviceId, S.templateId, templateParams)
                    .then(function() {
                        status.className = 'text-sm text-center text-green-600 font-bold';
                        status.innerText = '‚úÖ Message envoy√© avec succ√®s !';
                        document.getElementById('contactForm').reset();
                    }, function(error) {
                        console.error('EmailJS Error:', error);
                        status.className = 'text-sm text-center text-red-600 font-bold';
                        status.innerText = '‚ùå √âchec de l\'envoi. Veuillez r√©essayer plus tard.';
                    })
                    .finally(() => {
                        btn.disabled = false;
                        btn.innerText = originalText;
                        setTimeout(() => { status.innerText = ''; }, 5000);
                    });
            });
        }

        /**
         * Redirige l'utilisateur vers le Google Form pr√©-rempli pour la r√©servation.
         */
        function redirectToForm(event, id) {
            event.preventDefault();
            const formUrl = DATA.settings.formUrl;
            
            if (!formUrl) {
                return alert("L'URL de soumission du formulaire de r√©servation n'est pas configur√©e dans l'Admin. Veuillez la configurer et sauvegarder.");
            }
            
            // On trouve l'√©v√©nement pour pr√©-remplir le champ
            const evt = DATA.events.find(e => e.id == id);
            
            if (!evt) {
                 return alert("Erreur: √âv√©nement introuvable.");
            }

            // V√©rification des IDs du formulaire
            if (ENTRY_ID_EVENT.includes('VOTRE_ID_EVENT_ICI')) {
                return alert("Erreur de configuration: Veuillez d'abord ins√©rer les IDs de vos champs Google Form (ENTRY_ID_...) dans le fichier index.html, puis recharger la page.");
            }
            
            // L'URL de soumission doit √™tre formResponse
            const submissionUrl = formUrl.includes('formResponse') ? formUrl : formUrl.split('/viewform')[0] + '/formResponse';

            // Construction de l'URL avec l'√©v√©nement pr√©-rempli
            const eventInfo = encodeURIComponent(evt.title + (evt.date ? ' - ' + new Date(evt.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : ''));
            
            // On redirige vers le formulaire de Google avec le champ √âv√®nement pr√©-rempli
            // On utilise uniquement le champ √âV√àNEMENT (ENTRY_ID_EVENT) pour le pr√©-remplissage.
            const redirectUrl = `${submissionUrl}?entry.${ENTRY_ID_EVENT}=${eventInfo}`;
            
            window.open(redirectUrl, '_blank'); // Ouvre le lien dans un nouvel onglet
        }
        
        // Lancement de l'application au chargement de la page
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
