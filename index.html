<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservation Évènements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // --- CONFIGURATION EMAILJS (REMPLACEZ CES VALEURS) ---
        const EMAILJS_PUBLIC_KEY = "VOTRE_PUBLIC_KEY"; // ex: "user_xh4..."
        const EMAILJS_SERVICE_ID = "VOTRE_SERVICE_ID"; // ex: "service_gmail"
        const EMAILJS_TEMPLATE_ID = "VOTRE_TEMPLATE_ID"; // ex: "template_contact"
        
        (function(){
            try { emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e) { console.log("EmailJS non configuré"); }
        })();
    </script>

    <style>
        /* Variables dynamiques */
        :root { --primary-color: #2563eb; }
        .bg-theme { background-color: var(--primary-color); }
        .text-theme { color: var(--primary-color); }
        .border-theme { border-color: var(--primary-color); }
        .btn-theme { background-color: var(--primary-color); color: white; }
        .btn-theme:hover { filter: brightness(90%); }
        /* Loader pour la sauvegarde GitHub */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans flex flex-col min-h-screen">

    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="navLogo" src="" alt="Logo" class="h-10 w-10 object-contain rounded hidden">
                <span id="navOrgName" class="text-xl font-bold text-gray-700">Mon Association</span>
            </div>
            <button onclick="app.openAdminLogin()" class="text-sm text-gray-500 hover:text-theme transition">
                <i class="fas fa-cog"></i> Admin
            </button>
        </div>
    </nav>

    <header class="bg-theme text-white py-12 mb-8 transition-colors duration-500">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl font-bold mb-4">Nos Prochains Évènements</h1>
            <p class="text-lg opacity-90">Réservez votre place en quelques clics.</p>
        </div>
    </header>

    <main class="container mx-auto px-4 pb-12 flex-grow">
        <div id="eventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
    </main>

    <footer class="bg-gray-800 text-white py-6 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; <span id="footerYear"></span> <span id="footerOrgName">Mon Association</span>. Tous droits réservés.</p>
        </div>
    </footer>

    <div id="modalBooking" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative">
            <button onclick="app.closeModal('modalBooking')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-lg"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-theme">Inscription</h2>
            <p id="bookingEventTitle" class="text-gray-600 mb-6 font-medium"></p>
            <form id="bookingForm" onsubmit="app.handleBooking(event)">
                <input type="hidden" id="bookingEventId">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nom Complet</label>
                    <input type="text" id="userName" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="userEmail" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Téléphone</label>
                    <input type="tel" id="userPhone" class="w-full px-3 py-2 border rounded">
                </div>
                <button type="submit" class="w-full btn-theme font-bold py-3 px-4 rounded transition">Confirmer</button>
            </form>
        </div>
    </div>

    <div id="modalLogin" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 relative">
            <button onclick="app.closeModal('modalLogin')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-4 text-center">Accès Administrateur</h2>
            <form onsubmit="app.handleLogin(event)">
                <input type="password" id="adminPasswordInput" placeholder="Mot de passe" class="w-full px-3 py-2 border rounded mb-4">
                <button type="submit" class="w-full bg-gray-800 text-white font-bold py-2 rounded hover:bg-gray-700">Connexion</button>
            </form>
        </div>
    </div>

    <div id="modalAdmin" class="fixed inset-0 bg-gray-100 hidden z-50 overflow-y-auto">
        <div class="min-h-screen flex flex-col">
            <div class="bg-white shadow px-6 py-4 flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-theme"><i class="fas fa-user-shield"></i> Administration</h2>
                <div class="flex gap-3">
                    <button onclick="app.closeModal('modalAdmin')" class="text-red-500 hover:text-red-700 font-bold"><i class="fas fa-sign-out-alt"></i> Quitter</button>
                </div>
            </div>

            <div class="container mx-auto px-4 py-8 max-w-6xl flex-grow">
                <div class="flex mb-6 border-b overflow-x-auto">
                    <button onclick="app.switchTab('events')" id="tab-events" class="px-6 py-2 border-b-2 border-theme font-bold text-theme whitespace-nowrap">Évènements</button>
                    <button onclick="app.switchTab('registrations')" id="tab-registrations" class="px-6 py-2 border-b-2 border-transparent text-gray-500 whitespace-nowrap">Inscriptions</button>
                    <button onclick="app.switchTab('settings')" id="tab-settings" class="px-6 py-2 border-b-2 border-transparent text-gray-500 whitespace-nowrap">Paramètres & Cloud</button>
                </div>

                <div id="view-events" class="block">
                    <div class="bg-white rounded shadow p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4">Ajouter / Modifier</h3>
                        <form onsubmit="app.saveEvent(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="editEventId">
                            <input type="text" id="eventTitle" placeholder="Titre" required class="border p-2 rounded">
                            <input type="date" id="eventDate" required class="border p-2 rounded">
                            <input type="text" id="eventLocation" placeholder="Lieu" class="border p-2 rounded">
                            <input type="number" id="eventCapacity" placeholder="Capacité" required class="border p-2 rounded">
                            <input type="file" id="eventImage" accept="image/*" class="border p-2 rounded">
                            <textarea id="eventDesc" placeholder="Description" class="border p-2 rounded md:col-span-2" rows="2"></textarea>
                            <div class="md:col-span-2 text-right">
                                <button type="button" onclick="app.resetEventForm()" class="text-gray-500 mr-4">Annuler</button>
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 font-bold">Enregistrer (Local)</button>
                            </div>
                        </form>
                    </div>
                    <div id="adminEventsList" class="space-y-4"></div>
                </div>

                <div id="view-registrations" class="hidden">
                    <div class="bg-white rounded shadow overflow-x-auto">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr>
                                    <th class="px-5 py-3 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Évènement</th>
                                    <th class="px-5 py-3 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Nom</th>
                                    <th class="px-5 py-3 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Email</th>
                                    <th class="px-5 py-3 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Statut</th>
                                </tr>
                            </thead>
                            <tbody id="registrationsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-settings" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="bg-gray-800 text-white rounded shadow p-6 md:col-span-2 border border-gray-700">
                            <h3 class="text-lg font-bold mb-4 text-blue-400"><i class="fab fa-github"></i> Connexion Cloud (GitHub)</h3>
                            <p class="text-sm mb-4 text-gray-300">Remplissez ceci pour sauvegarder vos évènements et réglages directement sur votre site en ligne.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Pseudo GitHub (Owner)</label>
                                    <input type="text" id="ghOwner" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" placeholder="Ex: JeanDupont (PAS l'email !)">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Nom du Dépôt (Repo)</label>
                                    <input type="text" id="ghRepo" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" placeholder="Ex: mon-asso-site">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">Token (Secret)</label>
                                    <input type="password" id="ghToken" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" placeholder="ghp_xxxxxxxxxxxx">
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500 italic">Ces infos sont mémorisées sur cet ordinateur uniquement.</p>
                                <button id="btnPushGithub" type="button" onclick="app.pushToGitHub()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded transition flex items-center gap-2">
                                    <i class="fas fa-cloud-upload-alt"></i> Sauvegarder sur Internet
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded shadow p-6">
                            <h3 class="text-lg font-bold mb-4 border-b pb-2">Personnalisation</h3>
                            <form onsubmit="app.saveCustomSettings(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium">Nom Organisation</label>
                                    <input type="text" id="setOrgName" class="w-full border p-2 rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Couleur (Hex)</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="setThemeColorPicker" class="h-10 w-10 p-0 border-0" onchange="document.getElementById('setThemeColor').value = this.value">
                                        <input type="text" id="setThemeColor" class="w-full border p-2 rounded" placeholder="#2563eb">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Logo</label>
                                    <input type="file" id="setLogo" accept="image/*" class="w-full border p-2 rounded">
                                </div>
                                <button type="submit" class="w-full bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">Enregistrer Apparence (Local)</button>
                            </form>
                        </div>

                        <div class="bg-white rounded shadow p-6">
                            <h3 class="text-lg font-bold mb-4 border-b pb-2">Sécurité</h3>
                            <form onsubmit="app.changePassword(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium">Nouveau mot de passe Admin</label>
                                    <input type="text" id="setAdminPass" class="w-full border p-2 rounded" placeholder="Ex: asso2025">
                                </div>
                                <button type="submit" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">Changer Mot de Passe</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class EventApp {
            constructor() {
                // Initialisation config vide
                this.githubConfig = { owner: "", repo: "", path: "index.html", token: "" };

                // --- DONNÉES PAR DÉFAUT (Modifiées par la sauvegarde GitHub) ---
                this.defaultData = {
                    events: [
                        { id: 1, title: "Exemple d'évènement", date: "2025-09-01", location: "En ligne", capacity: 50, image: null, description: "Ceci est un exemple. Connectez-vous en Admin pour le supprimer et créer les vôtres." }
                    ],
                    settings: {
                        orgName: "Mon Asso",
                        themeColor: "#2563eb",
                        logoUrl: null,
                        adminPassword: "admin"
                    }
                };

                this.state = this.loadState();
                this.init();
            }

            // --- CORE ---
            loadState() {
                const storedData = localStorage.getItem('asso_app_data');
                const storedGh = localStorage.getItem('asso_gh_config');
                if(storedGh) this.githubConfig = JSON.parse(storedGh);
                return storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(this.defaultData));
            }

            saveState() {
                localStorage.setItem('asso_app_data', JSON.stringify(this.state));
                this.applyTheme();
                this.renderEvents();
            }

            init() {
                document.getElementById('footerYear').textContent = new Date().getFullYear();
                this.applyTheme();
                this.renderEvents();
                // Pré-remplir les champs GitHub s'ils sont en mémoire
                if(this.githubConfig.owner) document.getElementById('ghOwner').value = this.githubConfig.owner;
                if(this.githubConfig.repo) document.getElementById('ghRepo').value = this.githubConfig.repo;
                if(this.githubConfig.token) document.getElementById('ghToken').value = this.githubConfig.token;
            }

            applyTheme() {
                const s = this.state.settings;
                document.documentElement.style.setProperty('--primary-color', s.themeColor);
                document.getElementById('navOrgName').textContent = s.orgName;
                document.getElementById('footerOrgName').textContent = s.orgName;
                document.getElementById('setOrgName').value = s.orgName;
                document.getElementById('setThemeColor').value = s.themeColor;
                const logo = document.getElementById('navLogo');
                if (s.logoUrl) { logo.src = s.logoUrl; logo.classList.remove('hidden'); }
            }

            // --- ÉVÈNEMENTS & BOOKING ---
            renderEvents() {
                const grid = document.getElementById('eventsGrid');
                grid.innerHTML = '';
                this.state.events.forEach(evt => {
                    const regs = (this.state.registrations || []).filter(r => r.eventId == evt.id && r.status === 'confirmed');
                    const remaining = evt.capacity - regs.length;
                    const isFull = remaining <= 0;
                    const imgHtml = evt.image ? `<img src="${evt.image}" class="w-full h-48 object-cover">` : `<div class="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-image fa-3x"></i></div>`;
                    const btnHtml = isFull 
                        ? `<button onclick="app.openBookingModal(${evt.id}, true)" class="w-full bg-orange-500 text-white font-bold py-2 px-4 rounded">Liste d'attente</button>`
                        : `<button onclick="app.openBookingModal(${evt.id}, false)" class="w-full btn-theme font-bold py-2 px-4 rounded">S'inscrire (${remaining} places)</button>`;

                    const card = document.createElement('div');
                    card.className = "bg-white rounded-lg shadow-lg overflow-hidden flex flex-col hover:shadow-xl transition-shadow";
                    card.innerHTML = `${imgHtml}<div class="p-6 flex-grow"><h3 class="font-bold text-xl mb-2">${evt.title}</h3><p class="text-gray-600 text-sm mb-4"><i class="far fa-calendar-alt"></i> ${evt.date} &bull; ${evt.location}</p><p class="text-gray-700 text-base line-clamp-3">${evt.description}</p></div><div class="px-6 pb-6 mt-auto">${btnHtml}</div>`;
                    grid.appendChild(card);
                });
            }

            openBookingModal(id, isWaitlist) {
                const evt = this.state.events.find(e => e.id == id);
                if(!evt) return;
                document.getElementById('bookingEventId').value = id;
                document.getElementById('bookingEventTitle').innerHTML = isWaitlist ? `<span class="text-orange-600">[LISTE D'ATTENTE]</span> ${evt.title}` : `Pour : <strong>${evt.title}</strong>`;
                document.getElementById('bookingForm').reset();
                this.openModal('modalBooking');
            }

            handleBooking(e) {
                e.preventDefault();
                const evtId = document.getElementById('bookingEventId').value;
                const evt = this.state.events.find(ev => ev.id == evtId);
                const currentRegs = (this.state.registrations || []).filter(r => r.eventId == evtId && r.status === 'confirmed').length;
                const status = currentRegs >= evt.capacity ? 'waitlist' : 'confirmed';

                if (!this.state.registrations) this.state.registrations = [];
                const newReg = {
                    id: Date.now(),
                    eventId: evtId, eventName: evt.title,
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    phone: document.getElementById('userPhone').value,
                    status: status, date: new Date().toLocaleDateString()
                };
                this.state.registrations.push(newReg);
                this.saveState();
                
                // Email
                if(typeof emailjs !== 'undefined') {
                    const params = { event_title: evt.title, user_name: newReg.name, user_email: newReg.email, user_status: status, admin_email: "accueil@cor-tech.fr" };
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params).catch(e => console.error(e));
                    // Copie admin
                    emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {...params, user_email: "accueil@cor-tech.fr"}).catch(e=>{});
                }
                
                this.closeModal('modalBooking');
                alert(status === 'confirmed' ? "Inscription confirmée !" : "Vous êtes sur liste d'attente.");
                this.renderEvents();
            }

            // --- ADMIN ---
            openAdminLogin() { this.openModal('modalLogin'); }
            
            handleLogin(e) {
                e.preventDefault();
                if (document.getElementById('adminPasswordInput').value === this.state.settings.adminPassword) {
                    this.closeModal('modalLogin');
                    this.openModal('modalAdmin');
                    this.renderAdminEvents();
                    this.renderRegistrations();
                    this.switchTab('events');
                } else { alert("Mot de passe incorrect"); }
            }

            renderAdminEvents() {
                document.getElementById('adminEventsList').innerHTML = this.state.events.map(evt => `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded border">
                        <div><strong>${evt.title}</strong> <span class="text-sm text-gray-500">(${evt.date})</span></div>
                        <div>
                            <button onclick="app.editEvent(${evt.id})" class="text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="app.deleteEvent(${evt.id})" class="text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`).join('');
            }

            saveEvent(e) {
                e.preventDefault();
                const id = document.getElementById('editEventId').value;
                const file = document.getElementById('eventImage').files[0];
                
                const process = (img) => {
                    const data = {
                        id: id ? parseInt(id) : Date.now(),
                        title: document.getElementById('eventTitle').value,
                        date: document.getElementById('eventDate').value,
                        location: document.getElementById('eventLocation').value,
                        capacity: document.getElementById('eventCapacity').value,
                        description: document.getElementById('eventDesc').value,
                        image: img
                    };
                    if (id) {
                        const idx = this.state.events.findIndex(e => e.id == id);
                        if (!img) data.image = this.state.events[idx].image;
                        this.state.events[idx] = data;
                    } else {
                        if (!img) data.image = null;
                        this.state.events.push(data);
                    }
                    this.saveState();
                    this.renderAdminEvents();
                    this.resetEventForm();
                    alert("Enregistré localement. N'oubliez pas de 'Sauvegarder sur Internet' !");
                };

                if(file) {
                    const reader = new FileReader();
                    reader.onload = e => process(e.target.result);
                    reader.readAsDataURL(file);
                } else process(null);
            }

            deleteEvent(id) {
                if(confirm("Supprimer ?")) {
                    this.state.events = this.state.events.filter(e => e.id != id);
                    this.saveState();
                    this.renderAdminEvents();
                }
            }
            editEvent(id) {
                const e = this.state.events.find(x => x.id == id);
                document.getElementById('editEventId').value = e.id;
                document.getElementById('eventTitle').value = e.title;
                document.getElementById('eventDate').value = e.date;
                document.getElementById('eventLocation').value = e.location;
                document.getElementById('eventCapacity').value = e.capacity;
                document.getElementById('eventDesc').value = e.description;
            }
            resetEventForm() { document.getElementById('editEventId').value = ""; document.querySelector('#view-events form').reset(); }

            renderRegistrations() {
                const regs = this.state.registrations || [];
                document.getElementById('registrationsTableBody').innerHTML = regs.map(r => `
                    <tr><td class="px-5 py-2 border-b bg-white text-sm">${r.eventName}</td>
                    <td class="px-5 py-2 border-b bg-white text-sm font-bold">${r.name}</td>
                    <td class="px-5 py-2 border-b bg-white text-sm">${r.email}</td>
                    <td class="px-5 py-2 border-b bg-white text-sm"><span class="px-2 py-1 rounded-full ${r.status==='confirmed'?'bg-green-200 text-green-900':'bg-orange-200 text-orange-900'}">${r.status}</span></td></tr>
                `).join('');
            }

            // --- SETTINGS & GITHUB PUSH ---
            saveCustomSettings(e) {
                e.preventDefault();
                this.state.settings.orgName = document.getElementById('setOrgName').value;
                this.state.settings.themeColor = document.getElementById('setThemeColor').value;
                
                // On met à jour l'objet config sans le sauvegarder en local tout de suite
                // Il sera sauvegardé lors du Push pour éviter de stocker des données partielles
                
                const file = document.getElementById('setLogo').files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = ev => { this.state.settings.logoUrl = ev.target.result; this.saveState(); alert("Sauvegardé !"); };
                    reader.readAsDataURL(file);
                } else { this.saveState(); alert("Sauvegardé !"); }
            }

            changePassword(e) {
                e.preventDefault();
                const p = document.getElementById('setAdminPass').value;
                if(p) { this.state.settings.adminPassword = p; this.saveState(); alert("Mot de passe changé."); }
            }

            // --- FONCTION DE SAUVEGARDE GITHUB ROBUSTE ---
            async pushToGitHub() {
                // 1. Lire les valeurs depuis l'interface (TRÈS IMPORTANT)
                const owner = document.getElementById('ghOwner').value.trim();
                const repo = document.getElementById('ghRepo').value.trim();
                const token = document.getElementById('ghToken').value.trim();

                // 2. Mémoriser dans le navigateur pour la prochaine fois
                this.githubConfig = { owner, repo, token, path: "index.html" };
                localStorage.setItem('asso_gh_config', JSON.stringify(this.githubConfig));

                // 3. Vérifications
                if(!owner || !repo || !token) return alert("ERREUR : Il manque des informations. Remplissez les 3 cases.");
                if(owner.includes('@')) return alert("ERREUR : Le 'Pseudo GitHub' ne doit pas être un email.\nUtilisez votre nom d'utilisateur (ex: AliceFormation).");

                if(!confirm("Mettre à jour le site public ? Cela prendra environ 2 min.")) return;

                const btn = document.getElementById('btnPushGithub');
                const oldHTML = btn.innerHTML;
                btn.innerHTML = '<div class="loader"></div> Envoi...'; btn.disabled = true;

                try {
                    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${this.githubConfig.path}`;
                    
                    // GET : On lit le fichier actuel
                    const getRes = await fetch(apiUrl, { headers: { "Authorization": `token ${token}` } });
                    if(!getRes.ok) throw new Error("Accès refusé. Vérifiez le token et le nom du dépôt.");
                    const getData = await getRes.json();
                    
                    // On décode le contenu
                    const currentContent = new TextDecoder().decode(Uint8Array.from(atob(getData.content), c => c.charCodeAt(0)));
                    
                    // On prépare les nouvelles données
                    const newDataJson = JSON.stringify(this.state, null, 4);
                    
                    // On remplace le bloc "this.defaultData"
                    const newContent = currentContent.replace(/(this\.defaultData\s*=\s*)({[\s\S]*?})(;)/, `$1${newDataJson}$3`);
                    
                    // On encode en Base64 (compatible UTF-8)
                    const contentEncoded = btoa(unescape(encodeURIComponent(newContent)));

                    // PUT : On envoie la mise à jour
                    const putRes = await fetch(apiUrl, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: "Update via Admin", content: contentEncoded, sha: getData.sha })
                    });
                    
                    if(!putRes.ok) throw new Error("Erreur lors de l'écriture sur GitHub.");
                    
                    alert("✅ SUCCÈS ! Site mis à jour.\nLes changements seront visibles dans 2-3 minutes.");
                } catch(err) { 
                    console.error(err);
                    alert("ERREUR : " + err.message); 
                } 
                finally { btn.innerHTML = oldHTML; btn.disabled = false; }
            }

            // --- UTILS ---
            openModal(id) { document.getElementById(id).classList.remove('hidden'); }
            closeModal(id) { document.getElementById(id).classList.add('hidden'); }
            switchTab(t) {
                ['events','registrations','settings'].forEach(x => {
                    document.getElementById(`view-${x}`).classList.add('hidden');
                    document.getElementById(`tab-${x}`).classList.remove('border-theme','text-theme');
                });
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.getElementById(`tab-${t}`).classList.add('border-theme','text-theme');
            }
        }
        const app = new EventApp();
    </script>
</body>
</html>
