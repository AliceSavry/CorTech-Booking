<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portail Cor-Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* COULEURS DE LA CHARTE GRAPHIQUE */
        :root { 
            --primary-color: #00FFFF; /* Bleu Néon */
            --bg-dark: #111827;
            --card-dark: #1f2937;
        }
        /* Assurez-vous que les classes de couleur d'origine utilisent le néon */
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        
        /* Application des polices (du fichier d'origine) */
        body { font-family: 'Rajdhani', sans-serif; }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }

        /* Loader adapté au thème sombre et en Néon */
        #loading { position: fixed; inset: 0; background: var(--bg-dark); z-index: 50; display: flex; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #374151; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Fix pour le texte des news (respecte les retours à la ligne) */
        .news-content { white-space: pre-line; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans flex flex-col min-h-screen">

    <div id="loading"><div class="spinner"></div></div>

    <nav class="bg-gray-900 shadow-md sticky top-0 z-40 border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img id="logoSite" src="" class="h-10 w-10 object-contain hidden rounded-full border border-gray-700">
                <h1 id="orgName" class="text-3xl font-bold text-white">Cor-Tech</h1>
            </div>
            <a href="mailto:accueil@cor-tech.fr" class="bg-primary text-black font-semibold py-2 px-4 rounded-full text-sm hover:opacity-80 transition flex items-center gap-2">
                <i class="fas fa-envelope"></i> Nous contacter
            </a>
            </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8 hidden" id="mainContent">
        
        <div class="lg:col-span-1 space-y-6">

            <div id="eventsContainer" class="bg-gray-800 rounded-lg shadow-lg p-6 border-l-4 border-primary">
                <h2 class="text-xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-calendar-alt text-primary mr-3"></i> Évènements à venir</h2>
                <div id="eventsList" class="space-y-4">
                    <p id="noEvents" class="text-gray-500 italic hidden">Aucun événement planifié pour le moment.</p>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg shadow p-6 border border-gray-700">
                <h2 class="text-xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-clock text-orange-400 mr-3"></i> Horaires</h2>
                <div class="space-y-4">
                    <div><h3 class="font-bold text-gray-300 mb-1">Période Scolaire :</h3><pre id="hoursSchool" class="text-gray-400 whitespace-pre-wrap"></pre></div>
                    <div><h3 class="font-bold text-gray-300 mb-1">Vacances :</h3><pre id="hoursHolidays" class="text-gray-400 whitespace-pre-wrap"></pre></div>
                </div>
            </div>

            <div id="socialContainer" class="bg-gray-800 rounded-lg shadow p-6 border border-gray-700">
                <h2 class="text-xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-share-alt text-teal-400 mr-3"></i> Nous suivre</h2>
                <div id="socialLinks" class="flex justify-around items-center text-3xl"></div>
            </div>

        </div>


        <div class="lg:col-span-2">
            <h2 class="text-2xl font-extrabold text-white mb-4 flex items-center"><i class="fas fa-bullhorn text-red-500 mr-3"></i> Dernières Actualités</h2>
            <div id="newsList" class="grid grid-cols-1 gap-6">
                </div>
        </div>

    </main>

    <footer class="bg-gray-900 text-gray-400 p-6 mt-12 border-t border-gray-800">
        <div class="max-w-7xl mx-auto text-center">
            <p>&copy; <span id="currentYear"></span> <span id="footerOrgName">Cor-Tech</span>. Tous droits réservés.</p>
            <p class="mt-2 text-sm">
                <a href="mentions.html" class="text-gray-400 hover:text-primary underline">Mentions Légales</a>
                | <a href="admin.html" class="text-gray-400 hover:text-primary underline">Administration</a>
            </p>
        </div>
    </footer>

    <div id="modalBooking" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative">
            <button onclick="document.getElementById('modalBooking').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-2 text-primary">Inscription</h2>
            <p id="bookingEventTitle" class="text-gray-600 mb-6 font-medium"></p>
            <form id="bookingForm" onsubmit="handleBooking(event)">
                <input type="hidden" id="bookingEventId">
                <input type="text" id="userName" placeholder="Nom Complet" required class="w-full px-3 py-2 border rounded mb-3 text-gray-800">
                <input type="email" id="userEmail" placeholder="Email" required class="w-full px-3 py-2 border rounded mb-3 text-gray-800">
                <input type="tel" id="userPhone" placeholder="Téléphone" class="w-full px-3 py-2 border rounded mb-3 text-gray-800">
                <button type="submit" class="w-full bg-primary text-black font-bold py-3 px-4 rounded">Confirmer l'inscription</button>
            </form>
        </div>
    </div>

    <div id="modalNewsDetail" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full h-[90vh] flex flex-col relative">
            <button onclick="document.getElementById('modalNewsDetail').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 z-10 p-2 bg-white rounded-full hover:text-gray-900"><i class="fas fa-times fa-lg"></i></button>
            <div class="p-6 overflow-y-auto flex-grow" id="newsDetailContent">
                </div>
        </div>
    </div>


    <script>
        let DATA = {};
        const THEME_COLOR = '#00FFFF'; // Couleur Néon (Charte Graphique)
        
        // Les IDs sont chargés depuis data.json (DATA.settings.entryIds)

        async function initApp() {
            try {
                const response = await fetch('data.json?t=' + Date.now());
                if (!response.ok) throw new Error('Erreur chargement data.json');
                DATA = await response.json();
                
                renderApp();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');

            } catch (error) {
                console.error("Erreur critique:", error);
                document.getElementById('loading').innerHTML = `<div class="text-center text-red-600 font-bold p-4">Impossible de charger les données du site. ${error.message}</div>`;
            }
        }

        function setThemColor(color) {
            document.documentElement.style.setProperty('--primary-color', color);
        }

        function renderApp() {
            const S = DATA.settings;
            // Met à jour la couleur principale avec celle de la charte ou l'ancienne
            if (S.themeColor) setThemColor(S.themeColor); else setThemColor(THEME_COLOR);

            document.getElementById('orgName').textContent = S.orgName || 'Cor-Tech';
            document.getElementById('footerOrgName').textContent = S.orgName || 'Cor-Tech';
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            if(S.logoUrl) { 
                const logo=document.getElementById('logoSite'); 
                logo.src=S.logoUrl; 
                logo.classList.remove('hidden'); 
            }

            document.getElementById('hoursSchool').textContent = S.hours?.school || 'Non défini';
            document.getElementById('hoursHolidays').textContent = S.hours?.holidays || 'Non défini';
            
            renderSocialLinks(S.social);
            renderEvents(DATA.events);
            renderNews(DATA.news);
        }
        
        function renderSocialLinks(social) {
            const linksContainer = document.getElementById('socialLinks');
            linksContainer.innerHTML = '';
            const socialIcons = [
                { key: 'facebook', icon: 'fab fa-facebook-square', color: 'text-blue-600' },
                { key: 'instagram', icon: 'fab fa-instagram', color: 'text-pink-600' },
                { key: 'tiktok', icon: 'fab fa-tiktok', color: 'text-gray-200' }, // Clair sur fond sombre
                { key: 'youtube', icon: 'fab fa-youtube', color: 'text-red-600' }
            ];

            socialIcons.forEach(item => {
                const url = social?.[item.key];
                if (url) {
                    // Les cartes étant foncées, les icônes doivent ressortir
                    linksContainer.innerHTML += `<a href="${url}" target="_blank" class="${item.color} hover:opacity-75 transition"><i class="${item.icon}"></i></a>`;
                }
            });
            
            if (linksContainer.innerHTML === '') {
                document.getElementById('socialContainer').classList.add('hidden');
            } else {
                 document.getElementById('socialContainer').classList.remove('hidden');
            }
        }

        // RENDU ÉVÈNEMENTS (Colonne 1/3)
        function renderEvents(events) {
            const list = document.getElementById('eventsList');
            list.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const futureEvents = events.filter(evt => {
                const eventDate = new Date(evt.date);
                if (isNaN(eventDate)) return false; 
                return eventDate >= today;
            });
            
            const sortedEvents = futureEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (sortedEvents.length === 0) {
                document.getElementById('noEvents').classList.remove('hidden');
                return;
            }

            // Empilement vertical dans la zone 1/3
            list.classList.remove('md:grid-cols-2');
            list.classList.add('space-y-4');

            sortedEvents.forEach(evt => {
                const eventDate = new Date(evt.date);
                const dateStatus = isNaN(eventDate) 
                    ? `<span class="text-red-500 font-semibold">Date Invalide</span>` 
                    : `<i class="fas fa-calendar-day mr-1"></i> ${eventDate.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })}`;

                let statusBadge = '';
                if (evt.status) {
                    let color = 'text-gray-200 bg-gray-700'; // Fond de badge par défaut
                    if (evt.status === 'Complet') color = 'text-white bg-red-600';
                    else if (evt.status === 'Ouvert') color = 'text-black bg-primary'; // Néon pour "Ouvert"
                    else if (evt.status === 'Annulé') color = 'text-yellow-700 bg-yellow-100';

                    statusBadge = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${color} self-start">${evt.status}</span>`;
                }
                
                const buttonText = evt.status === 'Complet' ? "Liste d'attente" : "S'inscrire";

                // Mise à jour des couleurs de carte pour le thème sombre
                const html = `
                    <div class="flex bg-gray-900 p-3 rounded-lg border border-gray-700 hover:shadow-lg transition">
                        <div class="flex-shrink-0 w-16 h-16 mr-3 rounded-md overflow-hidden border border-gray-600">
                            ${evt.image ? `<img src="${evt.image}" alt="${evt.title}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-gray-500 text-xs text-center p-1"><i class="fas fa-image"></i></div>`}
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-bold text-white">${evt.title}</h3>
                            <div class="flex justify-between items-center">
                                <p class="text-sm text-primary font-semibold">${dateStatus}</p>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-gray-400 overflow-hidden max-h-10">${evt.description}</p>
                            <a href="#" onclick="openBookingModal(${evt.id})" class="text-xs font-semibold text-primary hover:text-white">${buttonText} <i class="fas fa-arrow-right ml-1"></i></a>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }
        
        // RENDU NEWS (Colonne 2/3)
        function renderNews(news) {
            const list = document.getElementById('newsList');
            list.innerHTML = '';
            const sortedNews = news.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedNews.length === 0) {
                list.innerHTML = '<p class="text-gray-500 md:col-span-2 italic">Aucune actualité récente à afficher.</p>';
                return;
            }

            // Rendu en pile (colonne unique)
            list.classList.remove('md:grid-cols-2');
            
            sortedNews.forEach(n => {
                const date = new Date(n.date).toLocaleDateString('fr-FR');
                // Logique pour l'extrait de 250 caractères
                const excerpt = n.content.length > 250 ? n.content.substring(0, 250).replace(/\s\S*$/, '') + '...' : n.content;

                // Mise à jour des couleurs de carte pour le thème sombre
                const html = `
                    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col h-full hover:shadow-xl transition duration-300 border border-gray-700">
                        ${n.image ? `<img src="${n.image}" alt="${n.title}" class="w-full h-48 object-cover">` : `<div class="w-full h-48 flex items-center justify-center bg-gray-900 text-gray-500 text-lg"><i class="fas fa-info-circle"></i></div>`}
                        <div class="p-5 flex flex-col flex-grow">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${n.tag === 'urgent' ? 'bg-red-700 text-white' : 'bg-primary text-black'} self-start mb-2">${n.tag}</span>
                            <h3 class="text-xl font-bold text-white mb-2">${n.title}</h3>
                            <p class="text-sm text-gray-400 mb-3 flex-grow news-content">${excerpt}</p>
                            <div class="flex justify-between items-center pt-3 border-t border-gray-700">
                                <span class="text-xs text-gray-500"><i class="fas fa-clock mr-1"></i> ${date}</span>
                                <a href="#" onclick="openNewsDetail(${n.id})" class="text-sm font-semibold text-primary hover:text-white">Lire la suite</a>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }
        
        // LOGIQUE MODAL ET SUBMISSION SILENCIEUSE (Inchangée)
        function openBookingModal(id) {
            const event = DATA.events.find(e => e.id == id);
            if (!event) return;
            
            if (!DATA.settings.formUrl) {
                alert("L'URL du formulaire de réservation n'est pas configurée dans l'Admin. Veuillez la configurer et sauvegarder.");
                return;
            }

            document.getElementById('bookingEventId').value = id;
            document.getElementById('bookingEventTitle').innerHTML = `Pour : <strong>${event.title}</strong>`;
            document.getElementById('modalBooking').classList.remove('hidden');
        }

        async function handleBooking(e) {
            e.preventDefault();
            const id = document.getElementById('bookingEventId').value;
            const event = DATA.events.find(x => x.id == id);
            
            const S = DATA.settings;
            
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const phone = document.getElementById('userPhone').value;
            
            const formUrl = S.formUrl;
            
            // 1. Logique de statut
            let userStatusForEmail = event.status === 'Complet' ? 'Liste d\'attente' : 'Confirmé';

            // 2. Vérification des IDs du formulaire (on les prend depuis data.json)
            const entryIds = S.entryIds;

            if (!entryIds?.event || !formUrl || !formUrl.includes('http')) {
                 alert("Erreur critique: Le lien de soumission ou les IDs du formulaire ne sont pas configurés dans l'Admin Panel.");
                 return;
            }

            // 3. Préparation du POST silencieux vers Google Forms
            const submissionUrl = formUrl.includes('/formResponse') ? formUrl : formUrl.split('/viewform')[0] + '/formResponse';
            const eventInfo = `${event.title} - ${event.date} à ${event.time || ''}`;
            
            const dataToSend = new URLSearchParams();
            dataToSend.append(`entry.${entryIds.nom}`, name);
            dataToSend.append(`entry.${entryIds.email}`, email);
            dataToSend.append(`entry.${entryIds.phone}`, phone);
            dataToSend.append(`entry.${entryIds.event}`, eventInfo);

            const btn = e.target.querySelector('button');
            const oldTxt = btn.innerText;
            
            btn.innerText = 'Envoi...';
            btn.disabled = true;

            try {
                const res = await fetch(submissionUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: dataToSend,
                });
                
                // 4. Envoi du mail de notification via EmailJS (Si configuré)
                if(S.emailjs?.serviceId && S.emailjs?.templateId) {
                    const p = { 
                        event_title: event.title, 
                        user_name: name, 
                        user_email: email, 
                        admin_email: "accueil@cor-tech.fr",
                        user_status: userStatusForEmail
                    };
                    emailjs.send(S.emailjs.serviceId, S.emailjs.templateId, p).catch(err => console.error("EmailJS Failed:", err));
                }

                alert(`✅ ${userStatusForEmail} ! Inscription enregistrée dans votre Google Sheet.`);

            } catch (error) {
                 alert(`✅ ${userStatusForEmail} ! Inscription enregistrée. (Veuillez vérifier votre feuille de calcul).`);
            }
            
            document.getElementById('modalBooking').classList.add('hidden');
            document.getElementById('bookingForm').reset();
            btn.innerText = oldTxt;
            btn.disabled = false;
        }

        // --- LOGIQUE MODAL DÉTAIL NEWS ---
        function openNewsDetail(id) {
            const newsItem = DATA.news.find(n => n.id == id);
            if (!newsItem) return;
            
            const detailContainer = document.getElementById('newsDetailContent');
            
            // Mise à jour des couleurs de badge pour le thème sombre
            const tagClasses = { 'info': 'bg-blue-600 text-white', 'urgent': 'bg-red-700 text-white', 'event': 'bg-green-600 text-white' };
            const tagText = { 'info': 'Information', 'urgent': 'URGENT', 'event': 'Vie Asso' };
            const tagClass = tagClasses[newsItem.tag] || 'bg-gray-600 text-white';
            const date = new Date(newsItem.date).toLocaleDateString('fr-FR');
            
            const imageHtml = newsItem.image 
                ? `<img src="${newsItem.image}" alt="${newsItem.title}" class="w-full h-auto max-h-[60vh] object-contain mb-4 rounded-lg shadow-md">` 
                : '';

            // Mise à jour des couleurs de texte dans la modale
            detailContainer.innerHTML = `
                <div class="pt-6">
                    <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tagClass} self-start mb-2">${tagText[newsItem.tag]}</span>
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4">${newsItem.title}</h2>
                    <p class="text-sm text-gray-500 mb-6"><i class="fas fa-calendar-alt mr-1"></i> Publié le ${date}</p>
                    
                    ${imageHtml}

                    <p class="text-lg text-gray-700 news-content">${newsItem.content}</p>
                </div>
            `;
            
            document.getElementById('modalNewsDetail').classList.remove('hidden');
        }

        // Lancement au chargement de la page
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
