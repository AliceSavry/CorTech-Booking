<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GÃ©nÃ©rateur de Prompts & Jeux HTML5 (+ Mode Troll)</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    :root{
      --app-bg-1:#0b1020;
      --app-bg-2:#101a3b;
      --panel: rgba(255,255,255,.08);
      --panel-2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --shadow: 0 16px 50px rgba(0,0,0,.35);
      --accent:#7c3aed;
      --accent-2:#22d3ee;
    }

    /* Background */
    body{
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(34,211,238,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(124,58,237,.18), transparent 60%),
        linear-gradient(135deg, var(--app-bg-1), var(--app-bg-2));
      color: var(--text);
    }

    .glass{
      background: linear-gradient(180deg, var(--panel), rgba(255,255,255,.06));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .soft-border{ border: 1px solid rgba(255,255,255,.12); }

    .chip{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    .codebox{
      background: rgba(6,10,20,.78);
      border: 1px solid rgba(255,255,255,.12);
    }

    .btn{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,211,238,.75));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .15s ease, filter .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(0px) scale(.99); }

    .btn-ghost{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      transition: transform .15s ease, filter .15s ease;
    }
    .btn-ghost:hover{ filter: brightness(1.08); transform: translateY(-1px); }

    .select, .check{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--text);
    }
    select option{ color: #0b1020; }

    .tab{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
    }
    .tab[data-active="true"]{
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.26);
    }

    /* Preview */
    .preview-frame{
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
    }

    .badge{
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.14);
    }

    /* Ambiance accents */
    .accent-kawaii{ --accent:#ff4fb6; --accent-2:#ffd1e8; }
    .accent-cyberpunk{ --accent:#00e5ff; --accent-2:#ff2bd6; }
    .accent-retro{ --accent:#22c55e; --accent-2:#f59e0b; }
    .accent-dark{ --accent:#64748b; --accent-2:#94a3b8; }
    .accent-nature{ --accent:#22c55e; --accent-2:#a3e635; }
    .accent-fantasy{ --accent:#a855f7; --accent-2:#f472b6; }
    .accent-scifi{ --accent:#22d3ee; --accent-2:#60a5fa; }
    .accent-minimalist{ --accent:#e5e7eb; --accent-2:#9ca3af; }
    .accent-funky{ --accent:#fb7185; --accent-2:#fbbf24; }
    .accent-horror{ --accent:#ef4444; --accent-2:#a3a3a3; }

    .focus-ring:focus{ outline: 2px solid rgba(34,211,238,.55); outline-offset: 2px; }

    /* Code scrollbar */
    pre{ scrollbar-color: rgba(255,255,255,.25) rgba(0,0,0,.15); }
    pre::-webkit-scrollbar{ height: 10px; width: 10px; }
    pre::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius: 10px; }
    pre::-webkit-scrollbar-track{ background: rgba(0,0,0,.15); }

    /* Troll Checkbox specific style */
    .check-troll:checked {
        accent-color: #ef4444;
        box-shadow: 0 0 10px #ef4444;
    }

    @media (prefers-reduced-motion: reduce){
      .btn, .btn-ghost{ transition: none; }
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <header class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between mb-8">
      <div>
        <div class="inline-flex items-center gap-2 badge rounded-full px-3 py-1 text-sm text-white/80">
          <span class="w-2 h-2 rounded-full" style="background: var(--accent);"></span>
          <span>Vanilla JS â€¢ Export HTML auto-contenu â€¢ PC + Mobile</span>
        </div>
        <h1 class="text-3xl md:text-4xl font-extrabold mt-3 tracking-tight">GÃ©nÃ©rateur de Prompts & Jeux HTML5</h1>
        <p class="text-white/70 mt-2 max-w-2xl">
          SÃ©lectionnez un template + une ambiance : lâ€™app gÃ©nÃ¨re un <b>prompt ultra dÃ©taillÃ©</b> (pour un LLM) et un <b>fichier HTML jouable</b>.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <button id="resetAll" class="btn-ghost rounded-xl px-4 py-2 text-sm focus-ring">RÃ©initialiser</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Form -->
      <section class="glass rounded-2xl p-5 md:p-6">
        <div class="flex items-center justify-between gap-3 mb-5">
          <h2 class="text-xl md:text-2xl font-bold">CritÃ¨res</h2>
          <div class="chip rounded-full px-3 py-1 text-xs text-white/70">GÃ©nÃ¨re Prompt + HTML</div>
        </div>

        <form id="gameForm" class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-white/80 mb-2">ğŸ® Template de jeu</label>
            <select id="gameType" class="select w-full rounded-xl px-4 py-3 focus-ring">
              <option value="clicker">ğŸª Cookie Clicker - Click rapide, upgrades exponentiels</option>
              <option value="idleBusiness">ğŸ’° Idle Business - Gains passifs, employÃ©s, buildings</option>
              <option value="tapTree">ğŸŒ³ Tap Tree - RÃ©colte fruits, croissance progressive</option>
              <option value="match3">ğŸ§© Match-3 Puzzle - Aligner 3+ Ã©lÃ©ments, combos</option>
              <option value="memory">ğŸ§  Memory Game - Retourner cartes identiques</option>
              <option value="whackMole">ğŸªœ Whack-a-Mole - Frapper cibles qui apparaissent</option>
              <option value="targetPractice">ğŸ¯ Target Practice - Tirer/pointer sur cibles mobiles</option>
              <option value="simonSays">ğŸ§  Simon Says - RÃ©pÃ©ter sÃ©quences croissantes</option>
              <option value="runner">ğŸ¦– Runner Infini - Sauter obstacles, score illimitÃ©</option>
              <option value="spaceShooter">ğŸš€ Space Shooter - Tirer sur ennemis, vagues</option>
              <option value="platformer">ğŸ® Platformer Simple - Sauter, plateforme, boss</option>
              <option value="flappyBird">ğŸ¦ Flappy Bird Clone - Ã‰viter obstacles par tap/click</option>
              <option value="dodgeEnemies">ğŸª Dodge Enemies - Ã‰viter ennemis mobiles, survie</option>
              <option value="warCard">ğŸƒ War Card Game - Cartes alÃ©atoires, bataille rapide</option>
              <option value="slotMachine">ğŸ° Slot Machine - Roulette chance, multiplicateurs</option>
              <option value="diceRoller">ğŸ² Dice Roller - Lancer dÃ©s, lucky numbers, scoring</option>
              <option value="colorMatch">ğŸŒˆ Color Match - Clicker sur couleur demandÃ©e</option>
              <option value="breakout">ğŸ§± Breakout - Balle rebondissante, briques</option>
              <option value="drawing">ğŸ¨ Drawing Game - Dessiner formes, reconnaissance simple</option>
              <option value="tetris">ğŸ§© Tetris-Like - Chutes de blocs, placement</option>
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-white/80 mb-2">ğŸ¨ Ambiance</label>
              <select id="ambiance" class="select w-full rounded-xl px-4 py-3 focus-ring">
                <option value="kawaii">ğŸŒ¸ Kawaii - pastel, emojis, sons aigus mignons</option>
                <option value="cyberpunk">ğŸŒ Cyberpunk - nÃ©on, synthÃ©, distortion sonore</option>
                <option value="retro">ğŸ‘¾ RÃ©tro - pixel art, 8-bit, bleep-bloop</option>
                <option value="dark">ğŸŒ‘ Dark - sombre, sons graves, ambiance sinistre</option>
                <option value="nature">ğŸŒ¿ Nature - verts, sons naturels, serein</option>
                <option value="fantasy">âš”ï¸ Fantasy - Ã©pique, cordes, sons magiques</option>
                <option value="scifi">ğŸ›¸ Sci-Fi - futuriste, pads Ã©lectroniques</option>
                <option value="minimalist">âšª Minimaliste - simple, Ã©purÃ©, sons courts</option>
                <option value="funky">ğŸ¸ Funky - groove, rÃ©tro-funk, percussions</option>
                <option value="horror">ğŸ‘» Horror - tension, bruits horrifiants, dissonance</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-white/80 mb-2">ğŸ–¥ï¸ Plateforme cible</label>
              <select id="platform" class="select w-full rounded-xl px-4 py-3 focus-ring">
                <option value="responsive" selected>ğŸ“±ğŸ’» Responsive (PC + Mobile)</option>
                <option value="mobile">ğŸ“± Mobile-first (touch + UI)</option>
                <option value="desktop">ğŸ’» Desktop (clavier/souris)</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold mb-2">ğŸ”Š Audio & Troll</div>
              <label class="flex items-center gap-3 text-white/80">
                <input type="checkbox" id="musicEnabled" class="check accent-[var(--accent)]" checked />
                <span>Musique gÃ©nÃ©rative</span>
              </label>
              <label class="flex items-center gap-3 mt-2 text-white/80">
                <input type="checkbox" id="soundsEnabled" class="check accent-[var(--accent)]" checked />
                <span>Effets sonores (SFX)</span>
              </label>
              
              <!-- TROLL MODE ADDED HERE -->
              <div class="mt-4 pt-3 border-t border-white/10">
                <label class="flex items-center gap-3 text-red-200 font-bold cursor-pointer group">
                    <input type="checkbox" id="trollMode" class="check check-troll" />
                    <span class="group-hover:text-red-400 transition-colors">ğŸ¤¡ Mode Troll (PiÃ¨ge)</span>
                </label>
                <p class="text-[10px] text-white/50 mt-1 pl-7 leading-tight">
                    Rend le jeu frustrant : contrÃ´les inversÃ©s, faux bugs, triche de l'IA.
                </p>
              </div>

            </div>
            <div class="glass rounded-2xl p-4">
              <div class="text-sm font-semibold mb-2">ğŸ›ï¸ QualitÃ© visuelle</div>
              <label class="block text-xs text-white/60 mb-2">Plus â€œproâ€ = HUD, particules, glow, canvas retina, transitions.</label>
              <input id="polish" type="range" min="1" max="3" value="3" class="w-full" />
              <div class="flex justify-between text-xs text-white/60 mt-1">
                <span>Rapide</span>
                <span>Pro</span>
              </div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3">
            <button type="submit" class="btn rounded-2xl px-5 py-3 font-bold focus-ring flex-1">ğŸš€ GÃ©nÃ©rer Prompt + Jeu</button>
            <button id="saveToLocal" type="button" class="btn-ghost rounded-2xl px-5 py-3 font-semibold focus-ring">ğŸ’¾ Sauvegarder</button>
          </div>

          <div class="text-xs text-white/60">
            Astuce : cliquez <b>Jouer</b> pour lancer un aperÃ§u rÃ©el. Le code exportÃ© est autonome.
          </div>
        </form>
      </section>

      <!-- Preview + Outputs -->
      <section class="space-y-6">
        <div class="glass rounded-2xl p-5 md:p-6">
          <div class="flex items-center justify-between gap-3 mb-4">
            <h2 class="text-xl md:text-2xl font-bold">AperÃ§u jouable</h2>
            <div id="previewMeta" class="text-xs text-white/70"></div>
          </div>

          <div class="soft-border rounded-2xl overflow-hidden relative" style="height: 360px;">
            <div id="previewPlaceholder" class="h-full flex items-center justify-center px-4">
              <div class="text-center max-w-md">
                <div class="text-3xl mb-2">ğŸ®</div>
                <div class="font-bold">GÃ©nÃ©rez un jeu pour lâ€™afficher ici</div>
                <p class="text-white/70 text-sm mt-2">Graphismes amÃ©liorÃ©s â€¢ Canvas retina â€¢ Responsive</p>
              </div>
            </div>
            <iframe id="previewFrame" class="preview-frame hidden" sandbox="allow-scripts allow-pointer-lock allow-same-origin" allow="autoplay"></iframe>
            <!-- Overlay for visual feedback when Troll mode is active in preview -->
            <div id="trollBadge" class="hidden absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider shadow-lg transform rotate-3 pointer-events-none">
                ğŸ¤¡ Troll Edition
            </div>
          </div>

          <div class="mt-4 grid grid-cols-2 gap-3">
            <button id="playButton" class="btn rounded-xl py-2 font-semibold focus-ring" disabled>â–¶ Jouer</button>
            <button id="stopButton" class="btn-ghost rounded-xl py-2 font-semibold focus-ring" disabled>â¹ ArrÃªter</button>
          </div>
        </div>

        <div class="glass rounded-2xl p-5 md:p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
            <h2 class="text-xl md:text-2xl font-bold">Sorties</h2>
            <div class="flex flex-wrap gap-2">
              <button class="tab rounded-full px-3 py-1 text-sm" id="tabPrompt" data-active="true">ğŸ§© Prompt</button>
              <button class="tab rounded-full px-3 py-1 text-sm" id="tabCode" data-active="false">ğŸ“„ HTML (dÃ©mo)</button>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2 mb-3">
            <button id="copyButton" class="btn-ghost rounded-xl px-4 py-2 text-sm font-semibold focus-ring" disabled>ğŸ“‹ Copier</button>
            <button id="downloadButton" class="btn-ghost rounded-xl px-4 py-2 text-sm font-semibold focus-ring" disabled>â¬‡ TÃ©lÃ©charger</button>
          </div>

          <pre id="output" class="codebox rounded-2xl p-4 overflow-auto max-h-80 text-xs sm:text-sm whitespace-pre-wrap">GÃ©nÃ©rez pour afficher le prompt et le code ici.</pre>
        </div>
      </section>
    </main>

    <footer class="mt-10 text-center text-white/60 text-sm pb-8">
      <div>Conseil : Le "Mode Troll" rendra le jeu volontairement injuste ou bizarre (contrÃ´les inversÃ©s, bugs visuels).</div>
    </footer>
  </div>

  <script>
    // --- Data ---
    const gameTemplates = {
      clicker: { name: "Cookie Clicker", description: "Click rapide, upgrades exponentiels" },
      idleBusiness: { name: "Idle Business", description: "Gains passifs, employÃ©s, buildings" },
      tapTree: { name: "Tap Tree", description: "RÃ©colte fruits, croissance progressive" },
      match3: { name: "Match-3 Puzzle", description: "Aligner 3+ Ã©lÃ©ments, combos" },
      memory: { name: "Memory Game", description: "Retourner cartes identiques" },
      whackMole: { name: "Whack-a-Mole", description: "Frapper cibles qui apparaissent" },
      targetPractice: { name: "Target Practice", description: "Tirer/pointer sur cibles mobiles" },
      simonSays: { name: "Simon Says", description: "RÃ©pÃ©ter sÃ©quences croissantes" },
      runner: { name: "Runner Infini", description: "Sauter obstacles, score illimitÃ©" },
      spaceShooter: { name: "Space Shooter", description: "Tirer sur ennemis, vagues" },
      platformer: { name: "Platformer Simple", description: "Sauter, plateforme, boss" },
      flappyBird: { name: "Flappy Bird Clone", description: "Ã‰viter obstacles par tap/click" },
      dodgeEnemies: { name: "Dodge Enemies", description: "Ã‰viter ennemis mobiles, survie" },
      warCard: { name: "War Card Game", description: "Cartes alÃ©atoires, bataille rapide" },
      slotMachine: { name: "Slot Machine", description: "Roulette chance, multiplicateurs" },
      diceRoller: { name: "Dice Roller", description: "Lancer dÃ©s, lucky numbers, scoring" },
      colorMatch: { name: "Color Match", description: "Clicker sur couleur demandÃ©e" },
      breakout: { name: "Breakout", description: "Balle rebondissante, briques" },
      drawing: { name: "Drawing Game", description: "Dessiner formes, reconnaissance simple" },
      tetris: { name: "Tetris-Like", description: "Chutes de blocs, placement" }
    };

    const ambiances = {
      kawaii: { name: "Kawaii", colors: ["#FFB6C1", "#FF69B4", "#A855F7", "#22D3EE"], css: { glow: 0.7 } },
      cyberpunk: { name: "Cyberpunk", colors: ["#00E5FF", "#FF2BD6", "#7C3AED", "#22C55E"], css: { glow: 1.0 } },
      retro: { name: "RÃ©tro", colors: ["#22C55E", "#F59E0B", "#60A5FA", "#EF4444"], css: { glow: 0.35 } },
      dark: { name: "Dark", colors: ["#0F172A", "#1F2937", "#94A3B8", "#EF4444"], css: { glow: 0.25 } },
      nature: { name: "Nature", colors: ["#14532D", "#22C55E", "#A3E635", "#60A5FA"], css: { glow: 0.25 } },
      fantasy: { name: "Fantasy", colors: ["#4C1D95", "#A855F7", "#F472B6", "#F59E0B"], css: { glow: 0.6 } },
      scifi: { name: "Sci-Fi", colors: ["#0EA5E9", "#22D3EE", "#60A5FA", "#A855F7"], css: { glow: 0.8 } },
      minimalist: { name: "Minimaliste", colors: ["#F3F4F6", "#E5E7EB", "#9CA3AF", "#111827"], css: { glow: 0.08 } },
      funky: { name: "Funky", colors: ["#FB7185", "#FBBF24", "#22C55E", "#60A5FA"], css: { glow: 0.55 } },
      horror: { name: "Horror", colors: ["#111827", "#7F1D1D", "#EF4444", "#A3A3A3"], css: { glow: 0.35 } }
    };

    // --- DOM ---
    const gameForm = document.getElementById('gameForm');
    const gameTypeSelect = document.getElementById('gameType');
    const ambianceSelect = document.getElementById('ambiance');
    const platformSelect = document.getElementById('platform');
    const polishRange = document.getElementById('polish');
    const musicCheck = document.getElementById('musicEnabled');
    const soundCheck = document.getElementById('soundsEnabled');
    const trollCheck = document.getElementById('trollMode'); // Checkbox Troll
    const playButton = document.getElementById('playButton');
    const stopButton = document.getElementById('stopButton');
    const copyButton = document.getElementById('copyButton');
    const downloadButton = document.getElementById('downloadButton');
    const tabPrompt = document.getElementById('tabPrompt');
    const tabCode = document.getElementById('tabCode');
    const output = document.getElementById('output');
    const previewFrame = document.getElementById('previewFrame');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    const previewMeta = document.getElementById('previewMeta');
    const trollBadge = document.getElementById('trollBadge');

    // --- State ---
    let currentPrompt = '';
    let currentGameCode = '';
    let activeTab = 'prompt';

    // --- Utilities ---
    function getGameEmoji(gameType){
      const emojis = {
        clicker:'ğŸª', idleBusiness:'ğŸ’°', tapTree:'ğŸŒ³', match3:'ğŸ§©', memory:'ğŸ§ ',
        whackMole:'ğŸªœ', targetPractice:'ğŸ¯', simonSays:'ğŸ§ ', runner:'ğŸ¦–',
        spaceShooter:'ğŸš€', platformer:'ğŸ®', flappyBird:'ğŸ¦', dodgeEnemies:'ğŸª',
        warCard:'ğŸƒ', slotMachine:'ğŸ°', diceRoller:'ğŸ²', colorMatch:'ğŸŒˆ',
        breakout:'ğŸ§±', drawing:'ğŸ¨', tetris:'ğŸ§©'
      };
      return emojis[gameType] || 'ğŸ®';
    }

    function setActiveTab(next){
      activeTab = next;
      tabPrompt.dataset.active = next === 'prompt' ? 'true' : 'false';
      tabCode.dataset.active = next === 'code' ? 'true' : 'false';
      renderOutput();
    }

    function renderOutput(){
      if (!currentPrompt && !currentGameCode) {
        output.textContent = 'GÃ©nÃ©rez pour afficher le prompt et le code ici.';
        return;
      }
      output.textContent = activeTab === 'prompt' ? currentPrompt : currentGameCode;
    }

    function applyAppAccent(ambianceKey){
      const a = ambiances[ambianceKey];
      const body = document.body;
      body.classList.remove(
        'accent-kawaii','accent-cyberpunk','accent-retro','accent-dark','accent-nature',
        'accent-fantasy','accent-scifi','accent-minimalist','accent-funky','accent-horror'
      );
      body.classList.add('accent-' + ambianceKey);
      document.documentElement.style.setProperty('--accent', a.colors[2] || '#7c3aed');
      document.documentElement.style.setProperty('--accent-2', a.colors[3] || '#22d3ee');
    }

    // --- Prompt Generator (Modified for Troll Mode) ---
    function buildPrompt({ gameType, ambianceKey, platform, musicEnabled, soundsEnabled, polish, trollMode }){
      const game = gameTemplates[gameType];
      const amb = ambiances[ambianceKey];

      const platformReq = platform === 'mobile'
        ? "Mobile-first : UI touch-friendly + gros boutons + gestes (tap/swipe si pertinent)."
        : platform === 'desktop'
          ? "Desktop : clavier + souris, raccourcis (Espace/FlÃ¨ches), feedback visuel."
          : "Responsive PC + Mobile : touch + clavier/souris, layout adaptatif, canvas retina.";

      const audioReq = "Audio:\n- Musique gÃ©nÃ©rative: " + (musicEnabled ? 'ON' : 'OFF') + "\n- Effets sonores: " + (soundsEnabled ? 'ON' : 'OFF') + "\n- Utiliser Tone.js + Web Audio API. DÃ©marrer lâ€™audio uniquement aprÃ¨s une interaction utilisateur.";

      const polishReq = polish >= 3
        ? "Polish PRO: HUD moderne, micro-animations, particules, glow, transitions, feedback haptique (vibration si mobile), save best score."
        : "Polish standard: UI propre, code fonctionnel.";

      // Logique Troll
      const trollReq = trollMode 
        ? "\nğŸ˜ˆ MODE TROLL ACTIVÃ‰ (CRITIQUE): Le jeu doit Ãªtre intentionnellement frustrant et drÃ´le. Exemples obligatoires : \n- ContrÃ´les inversÃ©s alÃ©atoirement ou glissants.\n- Hitboxes lÃ©gÃ¨rement dÃ©calÃ©es.\n- Messages moqueurs quand on perd (ex: 'Tu as essayÃ© ?').\n- Faux bugs visuels (glitch screen).\n- Sons ridicules ou dissonants.\n- Fais en sorte que le joueur puisse gagner, mais difficilement."
        : "Gameplay : Juste, Ã©quilibrÃ© et satisfaisant.";

      return [
        "Tu es un expert en dÃ©veloppement de jeux HTML5. GÃ©nÃ¨re un fichier unique et auto-contenu (un seul .html) qui implÃ©mente un jeu complet.",
        "\nCONTRAINTES TECHNIQUES:",
        "- Un seul fichier HTML (pas dâ€™assets externes sauf librairies CDN connues comme Tone.js).",
        "- Gameplay via Canvas 2D + UI HTML/CSS moderne.",
        "- " + platformReq,
        "- Canvas responsive + devicePixelRatio.",
        "- Ã‰cran: Menu â†’ Jeu â†’ Game Over, bouton Rejouer.",
        "\nJEU Ã€ CRÃ‰ER:",
        "- Template: " + getGameEmoji(gameType) + " " + game.name,
        "- Description: " + game.description,
        "- Ambiance: " + amb.name + " (" + amb.colors.join(', ') + ")",
        trollReq,
        "\n" + audioReq,
        "\nNIVEAU DE POLISH:",
        "- " + polishReq,
        "\nSORTIE ATTENDUE:",
        "- Retourne UNIQUEMENT le contenu du fichier .html."
      ].join('\n');
    }

    // --- Code Generator (Visual Demo Placeholder) ---
    function generateGameCode({ gameType, ambianceKey, platform, trollMode }){
      const game = gameTemplates[gameType];
      const amb = ambiances[ambianceKey];
      const titleSuffix = trollMode ? " (Troll Edition ğŸ¤¡)" : "";
      const title = game.name + ' â€” ' + amb.name + titleSuffix;
      const colors = amb.colors;

      return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>${title}</title>
  <style>
    body{ margin:0; overflow:hidden; background: radial-gradient(circle at center, ${colors[1]}, ${colors[0]}); color:white; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
    h1 { font-size: 2rem; text-shadow: 0 4px 10px rgba(0,0,0,0.5); text-align:center; }
    canvas { background: rgba(0,0,0,0.3); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width:100%; }
    .btn { margin-top:20px; padding:10px 20px; background:white; color:black; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
  </style>
</head>
<body>
  <h1>${title}</h1>
  <canvas id="gameCanvas"></canvas>
  <button class="btn" onclick="alert('${trollMode ? "Ah ah, tu as cru que Ã§a marcherait ? (Ceci est une dÃ©mo visuelle)" : "Jeu dÃ©mo gÃ©nÃ©rÃ© !"}')">Start Game</button>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = Math.min(window.innerWidth - 40, 600);
    canvas.height = canvas.width * 0.6;
    
    // Animation boucle simple pour la dÃ©mo
    let t = 0;
    function loop(){
      ctx.fillStyle = 'rgba(0,0,0,0.1)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '${colors[2]}';
      ctx.beginPath();
      // Mouvement erratique si Troll
      let x = canvas.width/2 + Math.sin(t) * ${trollMode ? 100 : 50};
      let y = canvas.height/2 + Math.cos(${trollMode ? "t*3" : "t"}) * 50;
      ctx.arc(x, y, 20, 0, Math.PI*2);
      ctx.fill();
      t += 0.05;
      requestAnimationFrame(loop);
    }
    loop();
  <\/script>
</body>
</html>`;
    }

    // --- Events ---
    gameForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const config = {
        gameType: gameTypeSelect.value,
        ambianceKey: ambianceSelect.value,
        platform: platformSelect.value,
        musicEnabled: musicCheck.checked,
        soundsEnabled: soundCheck.checked,
        polish: polishRange.value,
        trollMode: trollCheck.checked
      };

      // 1. Appliquer l'ambiance Ã  l'UI
      applyAppAccent(config.ambianceKey);
      
      // 2. GÃ©nÃ©rer Prompt
      currentPrompt = buildPrompt(config);
      
      // 3. GÃ©nÃ©rer Code DÃ©mo
      currentGameCode = generateGameCode(config);

      // 4. Update UI
      setActiveTab('prompt');
      previewMeta.textContent = `${gameTemplates[config.gameType].name} â€¢ ${ambiances[config.ambianceKey].name}`;
      
      // Enable buttons
      playButton.disabled = false;
      stopButton.disabled = true; // sera actif quand on joue
      copyButton.disabled = false;
      downloadButton.disabled = false;
      
      // Show/Hide Troll Badge on Preview
      if(config.trollMode) trollBadge.classList.remove('hidden');
      else trollBadge.classList.add('hidden');
    });

    // Gestion Tabs
    tabPrompt.addEventListener('click', () => setActiveTab('prompt'));
    tabCode.addEventListener('click', () => setActiveTab('code'));

    // Gestion Play/Stop
    playButton.addEventListener('click', () => {
      previewPlaceholder.classList.add('hidden');
      previewFrame.classList.remove('hidden');
      
      // Inject code into iframe
      const doc = previewFrame.contentWindow.document;
      doc.open();
      doc.write(currentGameCode);
      doc.close();

      playButton.disabled = true;
      stopButton.disabled = false;
    });

    stopButton.addEventListener('click', () => {
      previewPlaceholder.classList.remove('hidden');
      previewFrame.classList.add('hidden');
      previewFrame.src = 'about:blank'; // clear
      
      playButton.disabled = false;
      stopButton.disabled = true;
    });

    // Copier - Fixed to use execCommand for iframe compatibility
    copyButton.addEventListener('click', () => {
      const txt = activeTab === 'prompt' ? currentPrompt : currentGameCode;
      
      const textArea = document.createElement("textarea");
      textArea.value = txt;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if(successful) {
            const originalText = copyButton.textContent;
            copyButton.textContent = "âœ… CopiÃ© !";
            setTimeout(() => copyButton.textContent = originalText, 2000);
        } else {
             console.error('Fallback copy failed.');
             copyButton.textContent = "âŒ Erreur";
        }
      } catch (err) {
        console.error('Fallback copy error', err);
        copyButton.textContent = "âŒ Erreur";
      }
      
      document.body.removeChild(textArea);
    });

    // TÃ©lÃ©charger
    downloadButton.addEventListener('click', () => {
      const blob = new Blob([currentGameCode], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      // Nom du fichier : type_ambiance.html
      const name = `${gameTypeSelect.value}_${ambianceSelect.value}${trollCheck.checked ? '_troll' : ''}.html`;
      a.download = name;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Reset
    document.getElementById('resetAll').addEventListener('click', () => {
      gameForm.reset();
      applyAppAccent('scifi'); // default accent usually? or keep current
    });

  </script>
</body>
</html>
