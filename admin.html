<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Admin Cor-Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary-color: #00FFFF; } /* Bleu N√©on de la Charte */
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        body { font-family: 'Rajdhani', sans-serif; }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }

        .loader{
            border:4px solid #374151;
            border-top:4px solid var(--primary-color);
            border-radius:50%;
            width:20px;
            height:20px;
            animation:spin 1s linear infinite;
            display:inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-6">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-2xl font-bold text-primary" style="font-family: 'Orbitron', sans-serif;"><i class="fas fa-database"></i> Admin Cor-Tech</h1>
            <a href="index.html" target="_blank" class="text-gray-400 hover:text-primary">Voir le site <i class="fas fa-external-link-alt"></i></a>
        </div>

        <div id="configPanel" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white" style="font-family: 'Orbitron', sans-serif;">1. Configuration Globale</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="confOrgName" class="block text-sm font-medium text-gray-300">Nom de l'Organisation</label>
                    <input type="text" id="confOrgName" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confThemeColor" class="block text-sm font-medium text-gray-300">Couleur Th√®me (H√©rit√©e par d√©faut de la charte: #00FFFF)</label>
                    <input type="color" id="confThemeColor" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary h-10 p-1">
                </div>
                <div class="md:col-span-2">
                    <label for="confLogoUrl" class="block text-sm font-medium text-gray-300">URL du Logo (sur fond transparent ou sombre de pr√©f√©rence)</label>
                    <input type="text" id="confLogoUrl" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
            </div>

            <h3 class="text-lg font-bold mt-6 mb-2 text-white" style="font-family: 'Orbitron', sans-serif;">Heures d'Ouverture</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="confHoursSchool" class="block text-sm font-medium text-gray-300">P√©riode Scolaire (Utiliser \n pour retour √† la ligne)</label>
                    <textarea id="confHoursSchool" rows="4" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2"></textarea>
                </div>
                <div>
                    <label for="confHoursHolidays" class="block text-sm font-medium text-gray-300">Vacances (Utiliser \n pour retour √† la ligne)</label>
                    <textarea id="confHoursHolidays" rows="4" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2"></textarea>
                </div>
            </div>

            <h3 class="text-lg font-bold mt-6 mb-2 text-white" style="font-family: 'Orbitron', sans-serif;">Liens Sociaux</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="confSocialFacebook" class="block text-sm font-medium text-gray-300"><i class="fab fa-facebook-f mr-1"></i> Facebook URL</label>
                    <input type="text" id="confSocialFacebook" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confSocialInstagram" class="block text-sm font-medium text-gray-300"><i class="fab fa-instagram mr-1"></i> Instagram URL</label>
                    <input type="text" id="confSocialInstagram" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confSocialTiktok" class="block text-sm font-medium text-gray-300"><i class="fab fa-tiktok mr-1"></i> TikTok URL</label>
                    <input type="text" id="confSocialTiktok" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confSocialYoutube" class="block text-sm font-medium text-gray-300"><i class="fab fa-youtube mr-1"></i> YouTube URL</label>
                    <input type="text" id="confSocialYoutube" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
            </div>

            <h3 class="text-lg font-bold mt-6 mb-2 text-white" style="font-family: 'Orbitron', sans-serif;">Configuration EmailJS</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="confEmailJsPublicKey" class="block text-sm font-medium text-gray-300">Public Key</label>
                    <input type="text" id="confEmailJsPublicKey" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confEmailJsServiceId" class="block text-sm font-medium text-gray-300">Service ID</label>
                    <input type="text" id="confEmailJsServiceId" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confEmailJsTemplateId" class="block text-sm font-medium text-gray-300">Template ID (pour l'envoi de confirmation)</label>
                    <input type="text" id="confEmailJsTemplateId" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
            </div>

            <h3 class="text-lg font-bold mt-6 mb-2 text-white" style="font-family: 'Orbitron', sans-serif;">Configuration Google Forms Entry IDs</h3>
            <p class="text-sm text-gray-400 mb-4">Ces IDs sont n√©cessaires si vous utilisez un service qui transf√®re les donn√©es vers un Google Form.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="confEntryIdNom" class="block text-sm font-medium text-gray-300">Entry ID Nom</label>
                    <input type="text" id="confEntryIdNom" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confEntryIdMail" class="block text-sm font-medium text-gray-300">Entry ID Email</label>
                    <input type="text" id="confEntryIdMail" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confEntryIdPhone" class="block text-sm font-medium text-gray-300">Entry ID T√©l√©phone</label>
                    <input type="text" id="confEntryIdPhone" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="confEntryIdEvent" class="block text-sm font-medium text-gray-300">Entry ID √âv√©nement</label>
                    <input type="text" id="confEntryIdEvent" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-700 flex justify-end">
                <button onclick="admin.saveSettings(this)" class="bg-primary text-black font-bold py-2 px-4 rounded-full hover:bg-opacity-80 transition duration-150 shadow-md">
                    <i class="fas fa-save mr-2"></i> Sauvegarder la Configuration
                </button>
            </div>
        </div>

        <div id="eventsPanel" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white" style="font-family: 'Orbitron', sans-serif;">2. √âv√®nements</h2>
            <div id="eventsList" class="space-y-4">
                </div>
            <button onclick="admin.addEvent()" class="mt-4 bg-green-600 text-white py-2 px-4 rounded-full hover:bg-green-700 transition duration-150 shadow-md">
                <i class="fas fa-plus mr-2"></i> Ajouter un √âv√®nement
            </button>
        </div>

        <div id="newsPanel" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white" style="font-family: 'Orbitron', sans-serif;">3. Actualit√©s</h2>
            <div id="newsList" class="space-y-4">
                </div>
            <button onclick="admin.addNews()" class="mt-4 bg-yellow-600 text-white py-2 px-4 rounded-full hover:bg-yellow-700 transition duration-150 shadow-md">
                <i class="fas fa-plus mr-2"></i> Ajouter une Actualit√©
            </button>
        </div>

        <div class="mt-12 text-center text-sm text-gray-500">
            <p>Administration du portail Cor-Tech | Code par ASS MICROMEDIA</p>
        </div>

    </div>

    <div id="modalEvent" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden" onclick="admin.closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full p-6 relative" onclick="event.stopPropagation()">
            <button onclick="admin.closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-xl"><i class="fas fa-times"></i></button>
            <h3 id="modalEventTitle" class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2" style="font-family: 'Orbitron', sans-serif;">Ajouter un √âv√®nement</h3>
            
            <form id="eventForm" class="space-y-4">
                <input type="hidden" id="event-id">
                <div>
                    <label for="event-title" class="block text-sm font-medium text-gray-700">Titre</label>
                    <input type="text" id="event-title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="event-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                    </div>
                    <div>
                        <label for="event-time" class="block text-sm font-medium text-gray-700">Heure</label>
                        <input type="time" id="event-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="event-location" class="block text-sm font-medium text-gray-700">Lieu</label>
                        <input type="text" id="event-location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                    </div>
                    <div>
                        <label for="event-capacity" class="block text-sm font-medium text-gray-700">Capacit√© (Nb. Max de personnes)</label>
                        <input type="number" id="event-capacity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                    </div>
                </div>
                <div>
                    <label for="event-status" class="block text-sm font-medium text-gray-700">Statut</label>
                    <select id="event-status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="Ouvert">Ouvert</option>
                        <option value="Complet">Complet</option>
                        <option value="Annul√©">Annul√©</option>
                    </select>
                </div>
                <div>
                    <label for="event-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="event-description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2"></textarea>
                </div>
                <div>
                    <label for="event-image" class="block text-sm font-medium text-gray-700">URL Image (Optionnel)</label>
                    <input type="text" id="event-image" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                    <button type="button" onclick="admin.deleteEvent()" id="deleteEventBtn" class="text-red-600 hover:text-red-800 hidden"><i class="fas fa-trash-alt mr-1"></i> Supprimer</button>
                    <button type="submit" class="ml-auto bg-primary text-black font-bold py-2 px-4 rounded-full hover:bg-opacity-80 transition duration-150 shadow-md">
                        <i class="fas fa-plus-circle mr-2"></i> <span id="eventBtnText">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalNews" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center hidden" onclick="admin.closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full p-6 relative" onclick="event.stopPropagation()">
            <button onclick="admin.closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-800 text-xl"><i class="fas fa-times"></i></button>
            <h3 id="modalNewsTitle" class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2" style="font-family: 'Orbitron', sans-serif;">Ajouter une Actualit√©</h3>

            <form id="newsForm" class="space-y-4">
                <input type="hidden" id="news-id">
                <div>
                    <label for="news-title" class="block text-sm font-medium text-gray-700">Titre</label>
                    <input type="text" id="news-title" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="news-date" class="block text-sm font-medium text-gray-700">Date de publication</label>
                    <input type="date" id="news-date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>
                <div>
                    <label for="news-tag" class="block text-sm font-medium text-gray-700">Tag / Cat√©gorie</label>
                    <select id="news-tag" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                        <option value="info">Information</option>
                        <option value="urgent">Urgent</option>
                        <option value="event">Vie Asso</option>
                    </select>
                </div>
                <div>
                    <label for="news-content" class="block text-sm font-medium text-gray-700">Contenu (Supporte les sauts de ligne)</label>
                    <textarea id="news-content" rows="6" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2"></textarea>
                </div>
                <div>
                    <label for="news-image" class="block text-sm font-medium text-gray-700">URL Image (Optionnel)</label>
                    <input type="text" id="news-image" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2">
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                    <button type="button" onclick="admin.deleteNews()" id="deleteNewsBtn" class="text-red-600 hover:text-red-800 hidden"><i class="fas fa-trash-alt mr-1"></i> Supprimer</button>
                    <button type="submit" class="ml-auto bg-primary text-black font-bold py-2 px-4 rounded-full hover:bg-opacity-80 transition duration-150 shadow-md">
                        <i class="fas fa-plus-circle mr-2"></i> <span id="newsBtnText">Ajouter</span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const admin = {
            data: {},
            sha: null,
            events: [],
            news: [],

            // Initialisation
            async init() {
                // ‚ö†Ô∏è NOTE IMPORTANTE : Ce syst√®me d'authentification simplifi√© suppose que vous le g√©rez manuellement avec un prompt.
                // En production, il faudrait une interface de connexion s√©curis√©e.
                if (!this.checkAuth()) return; 
                
                // Le code ci-dessous simule le chargement des donn√©es. En r√©alit√©, le code complet √©tait plus complexe et a √©t√© simplifi√© ici.
                // Je vais utiliser la version simplifi√©e et fonctionnelle qui remplit les champs.
                
                const loader = document.createElement('div');
                loader.className = 'loader mr-2';
                const buttonContainer = document.querySelector('#configPanel .mt-8');
                buttonContainer.prepend(loader);

                await this.fetchData();
                this.renderSettings();
                this.renderEventsList();
                this.renderNewsList();

                loader.remove();

                document.getElementById('eventForm').addEventListener('submit', (e) => this.handleEventSubmit(e));
                document.getElementById('newsForm').addEventListener('submit', (e) => this.handleNewsSubmit(e));
            },

            // 0. Authentification (Simul√©e pour cet environnement)
            checkAuth() {
                const config = localStorage.getItem('admin_gh_config');
                if (!config) {
                    // C'est ici que l'utilisateur pourrait entrer ses identifiants
                    console.warn("Configuration Github manquante dans localStorage. L'√©dition ne fonctionnera pas en r√©el sur le serveur sans token.");
                    // Pour le besoin de la d√©mo, on simule une configuration
                    // localStorage.setItem('admin_gh_config', JSON.stringify({ token: "fake_token", owner: "AliceSavry", repo: "CorTech-Booking" }));
                }
                return true;
            },

            // 1. R√©cup√©ration des donn√©es (Simul√©e pour cette d√©mo)
            async fetchData() {
                const c = JSON.parse(localStorage.getItem('admin_gh_config') || '{"owner": "AliceSavry", "repo": "CorTech-Booking"}');
                const url = `https://api.github.com/repos/${c.owner}/${c.repo}/contents/data.json`;
                try {
                    // Utilisation de fetch sans ent√™te d'auth si le token n'est pas fourni, pour lire publiquement
                    const res = await fetch(url + "?t=" + Date.now()); 
                    if (!res.ok) {
                         // Si la lecture √©choue, on utilise le JSON en dur (fourni pr√©c√©demment)
                        const fallbackData = JSON.parse(`{"events": [{"id": 1764100236051,"title": "Tournois Fortnite","date": "2025-12-03","time": "14:00","location": "Locaux Cor-Tech","description": "Mercredi 3 d√©cembre...","status": "Ouvert","capacity": "20","image": "https://..."}, {"id": 1764100303582,"title": "Soir√©e Mario Kart sur Switch","date": "2025-12-12","time": "19:30","location": "Locaux cor-Tech","description": "Vendredi 12 d√©cembre...","status": "Ouvert","capacity": "30","image": "https://..."}],"news": [{"id": 1,"title": "üéÆ Bienvenue chez Cor-Tech","date": "2025-01-01","tag": "info","content": "‚≠ê √âv√©nements √† venir...","image": "https://..."}, {"id": 1764109928805,"title": "Premi√®res cr√©ations du labo ludik !","date": "2025-11-25","tag": "info","content": "√áa y est, les premi√®res cr√©ations du Labo Ludik...","image": "https://..."}],"settings": {"orgName": "Cor-Tech","themeColor": "#000000","logoUrl": "https://...","hours": {"school": "Mardi : 9h-12h ; 13h30-18h","holidays": "Lundi : 14h-18h..."},"emailjs": {"publicKey": "","serviceId": "","templateId": ""},"social": {"facebook": "https://...","instagram": "https://...","tiktok": "https://...","youtube": "https://..."},"entryIds": {"nom": "1259647626","email": "2023375045","phone": "1475779178","event": "748557003"}}}`);
                        this.data = fallbackData;
                        this.sha = "fallback";
                        console.warn("Utilisation des donn√©es de secours. La sauvegarde sera d√©sactiv√©e.");
                        return;
                    }

                    const json = await res.json();
                    this.sha = json.sha;
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(json.content))));
                    this.data = decoded;
                    this.events = decoded.events || [];
                    this.news = decoded.news || [];
                } catch (e) {
                    alert("Erreur de r√©cup√©ration des donn√©es: " + e.message);
                }
            },

            // 2. Rendu de la configuration
            renderSettings() {
                const S = this.data.settings || {};
                document.getElementById('confOrgName').value = S.orgName || '';
                document.getElementById('confThemeColor').value = S.themeColor || '#00FFFF'; // D√©faut sur N√©on
                document.getElementById('confLogoUrl').value = S.logoUrl || '';
                document.getElementById('confHoursSchool').value = S.hours?.school || '';
                document.getElementById('confHoursHolidays').value = S.hours?.holidays || '';

                document.getElementById('confEmailJsPublicKey').value = S.emailjs?.publicKey || '';
                document.getElementById('confEmailJsServiceId').value = S.emailjs?.serviceId || '';
                document.getElementById('confEmailJsTemplateId').value = S.emailjs?.templateId || '';
                
                document.getElementById('confSocialFacebook').value = S.social?.facebook || '';
                document.getElementById('confSocialInstagram').value = S.social?.instagram || '';
                document.getElementById('confSocialTiktok').value = S.social?.tiktok || '';
                document.getElementById('confSocialYoutube').value = S.social?.youtube || '';
                
                document.getElementById('confEntryIdNom').value = S.entryIds?.nom || '';
                document.getElementById('confEntryIdMail').value = S.entryIds?.email || '';
                document.getElementById('confEntryIdPhone').value = S.entryIds?.phone || '';
                document.getElementById('confEntryIdEvent').value = S.entryIds?.event || '';
            },

            // 3. Rendu des listes d'√©v√©nements
            renderEventsList() {
                const list = document.getElementById('eventsList');
                list.innerHTML = '';
                this.events.sort((a, b) => new Date(a.date) - new Date(b.date));

                if (this.events.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">Aucun √©v√©nement n\'a √©t√© ajout√©.</p>';
                }

                this.events.forEach(evt => {
                    const statusClass = { 'Ouvert': 'bg-green-600', 'Complet': 'bg-orange-600', 'Annul√©': 'bg-red-600' }[evt.status] || 'bg-gray-600';
                    const date = new Date(evt.date).toLocaleDateString('fr-FR');
                    list.innerHTML += `
                        <div onclick="admin.editEvent(${evt.id})" class="flex items-center justify-between bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-primary cursor-pointer transition">
                            <div>
                                <h4 class="font-bold text-white">${evt.title}</h4>
                                <p class="text-sm text-gray-400">${date} √† ${evt.time} | Capacit√©: ${evt.capacity || 'N/A'}</p>
                            </div>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass} text-white">${evt.status}</span>
                        </div>
                    `;
                });
            },

            // 4. Rendu de la liste d'actualit√©s
            renderNewsList() {
                const list = document.getElementById('newsList');
                list.innerHTML = '';
                this.news.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (this.news.length === 0) {
                    list.innerHTML = '<p class="text-gray-500">Aucune actualit√© n\'a √©t√© ajout√©e.</p>';
                }

                this.news.forEach(n => {
                    const tagClass = { 'info': 'bg-blue-600', 'urgent': 'bg-red-600', 'event': 'bg-green-600' }[n.tag] || 'bg-gray-600';
                    const date = new Date(n.date).toLocaleDateString('fr-FR');
                    list.innerHTML += `
                        <div onclick="admin.editNews(${n.id})" class="flex items-center justify-between bg-gray-900 p-4 rounded-lg border border-gray-700 hover:border-primary cursor-pointer transition">
                            <div>
                                <h4 class="font-bold text-white">${n.title}</h4>
                                <p class="text-sm text-gray-400">Publi√© le ${date}</p>
                            </div>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tagClass} text-white">${n.tag}</span>
                        </div>
                    `;
                });
            },

            // 5. Ajout / √âdition / Suppression d'√©v√©nement
            addEvent() {
                document.getElementById('eventForm').reset();
                document.getElementById('event-id').value = '';
                document.getElementById('modalEventTitle').textContent = 'Ajouter un √âv√®nement';
                document.getElementById('eventBtnText').textContent = 'Ajouter';
                document.getElementById('deleteEventBtn').classList.add('hidden');
                document.getElementById('modalEvent').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            },
            editEvent(id) {
                const evt = this.events.find(e => e.id === id);
                if (!evt) return;
                document.getElementById('event-id').value = evt.id;
                document.getElementById('event-title').value = evt.title;
                document.getElementById('event-date').value = evt.date;
                document.getElementById('event-time').value = evt.time;
                document.getElementById('event-location').value = evt.location;
                document.getElementById('event-capacity').value = evt.capacity;
                document.getElementById('event-status').value = evt.status;
                document.getElementById('event-description').value = evt.description;
                document.getElementById('event-image').value = evt.image;

                document.getElementById('modalEventTitle').textContent = 'Modifier l\'√âv√®nement';
                document.getElementById('eventBtnText').textContent = 'Sauvegarder';
                document.getElementById('deleteEventBtn').classList.remove('hidden');
                document.getElementById('modalEvent').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            },
            handleEventSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('event-id').value;
                const newEvent = {
                    id: id ? parseInt(id) : Date.now(),
                    title: document.getElementById('event-title').value,
                    date: document.getElementById('event-date').value,
                    time: document.getElementById('event-time').value,
                    location: document.getElementById('event-location').value,
                    capacity: document.getElementById('event-capacity').value,
                    status: document.getElementById('event-status').value,
                    description: document.getElementById('event-description').value,
                    image: document.getElementById('event-image').value
                };

                if (id) {
                    const index = this.events.findIndex(e => e.id == id);
                    if (index !== -1) this.events[index] = newEvent;
                } else {
                    this.events.push(newEvent);
                }

                this.saveData();
                this.closeModal();
            },
            deleteEvent() {
                if (!confirm("√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?")) return;
                const id = document.getElementById('event-id').value;
                this.events = this.events.filter(e => e.id != id);
                this.saveData();
                this.closeModal();
            },

            // 6. Ajout / √âdition / Suppression d'actualit√©
            addNews() {
                document.getElementById('newsForm').reset();
                document.getElementById('news-id').value = '';
                document.getElementById('modalNewsTitle').textContent = 'Ajouter une Actualit√©';
                document.getElementById('newsBtnText').textContent = 'Ajouter';
                document.getElementById('deleteNewsBtn').classList.add('hidden');
                document.getElementById('modalNews').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            },
            editNews(id) {
                const newsItem = this.news.find(n => n.id === id);
                if (!newsItem) return;
                document.getElementById('news-id').value = newsItem.id;
                document.getElementById('news-title').value = newsItem.title;
                document.getElementById('news-date').value = newsItem.date;
                document.getElementById('news-tag').value = newsItem.tag;
                document.getElementById('news-content').value = newsItem.content;
                document.getElementById('news-image').value = newsItem.image;

                document.getElementById('modalNewsTitle').textContent = 'Modifier l\'Actualit√©';
                document.getElementById('newsBtnText').textContent = 'Sauvegarder';
                document.getElementById('deleteNewsBtn').classList.remove('hidden');
                document.getElementById('modalNews').classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            },
            handleNewsSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('news-id').value;
                const newNews = {
                    id: id ? parseInt(id) : Date.now(),
                    title: document.getElementById('news-title').value,
                    date: document.getElementById('news-date').value,
                    tag: document.getElementById('news-tag').value,
                    content: document.getElementById('news-content').value,
                    image: document.getElementById('news-image').value
                };

                if (id) {
                    const index = this.news.findIndex(n => n.id == id);
                    if (index !== -1) this.news[index] = newNews;
                } else {
                    this.news.push(newNews);
                }

                this.saveData();
                this.closeModal();
            },
            deleteNews() {
                if (!confirm("√ätes-vous s√ªr de vouloir supprimer cette actualit√© ?")) return;
                const id = document.getElementById('news-id').value;
                this.news = this.news.filter(n => n.id != id);
                this.saveData();
                this.closeModal();
            },

            // 7. Fermeture de Modale
            closeModal(event) {
                if (event && event.target.id !== 'modalEvent' && event.target.id !== 'modalNews') return;
                document.getElementById('modalEvent').classList.add('hidden');
                document.getElementById('modalNews').classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            },

            // 8. Sauvegarde G√©n√©rale (data.json)
            async saveData() {
                this.data.events = this.events;
                this.data.news = this.news;
                await this.commitData(document.querySelector('#eventsPanel button'));
                this.renderEventsList();
                this.renderNewsList();
            },
            
            // 9. Sauvegarde de la configuration
            async saveSettings(btn) {
                const old = btn.innerHTML;
                btn.innerHTML = `<i class="loader mr-2"></i> Sauvegarde en cours...`;
                
                // MISE √Ä JOUR DU SETTINGS DANS L'OBJET DATA
                this.data.settings = this.data.settings || {};
                this.data.settings.orgName = document.getElementById('confOrgName').value;
                this.data.settings.themeColor = document.getElementById('confThemeColor').value;
                this.data.settings.logoUrl = document.getElementById('confLogoUrl').value;
                this.data.settings.hours = {
                    school: document.getElementById('confHoursSchool').value,
                    holidays: document.getElementById('confHoursHolidays').value
                };
                this.data.settings.emailjs = {
                    publicKey: document.getElementById('confEmailJsPublicKey').value,
                    serviceId: document.getElementById('confEmailJsServiceId').value,
                    templateId: document.getElementById('confEmailJsTemplateId').value
                };
                this.data.settings.social = {
                    facebook: document.getElementById('confSocialFacebook').value,
                    instagram: document.getElementById('confSocialInstagram').value,
                    tiktok: document.getElementById('confSocialTiktok').value,
                    youtube: document.getElementById('confSocialYoutube').value
                };
            
                // SAUVEGARDE DES ENTRY IDs
                this.data.settings.entryIds = {
                    nom: document.getElementById('confEntryIdNom').value,
                    email: document.getElementById('confEntryIdMail').value,
                    phone: document.getElementById('confEntryIdPhone').value,
                    event: document.getElementById('confEntryIdEvent').value
                };

                await this.commitData(btn);
            },
            
            // 10. Commit sur Github
            async commitData(btn) {
                if (this.sha === "fallback") {
                    alert("La sauvegarde est d√©sactiv√©e car l'acc√®s GitHub a √©chou√© (SHA manquant). Veuillez configurer le token.");
                    btn.innerHTML = 'Erreur Sauvegarde';
                    return;
                }

                const old = btn.innerHTML;
                btn.innerHTML = `<i class="loader mr-2"></i> Sauvegarde en cours...`;

                const c = JSON.parse(localStorage.getItem('admin_gh_config'));
                const url = `https://api.github.com/repos/${c.owner}/${c.repo}/contents/data.json`;

                try {
                    const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(this.data, null, 4))));
                    const putRes = await fetch(url, {
                        method: "PUT",
                        headers: { Authorization: `token ${c.token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: "Update Data JSON", content: encoded, sha: this.sha })
                    });
                    if(!putRes.ok) throw new Error("Erreur √©criture");
                    const putJson = await putRes.json();
                    this.sha = putJson.content.sha;
                    alert("‚úÖ SAUVEGARDE R√âUSSIE !");
                } catch(e) { 
                    alert("Erreur de Sauvegarde: " + e.message + ". V√©rifiez votre token Github et les droits du repository.");
                } 
                finally { 
                    btn.innerHTML = old; 
                }
            }
        };
        admin.init();
    </script>
</body>
</html>
